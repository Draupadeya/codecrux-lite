<!DOCTYPE html>
<html lang="en">
<<<<<<< HEAD
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCrux Student Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; }
        .sidebar-bg { background-color: #1a1c3d; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .progress-bg { background-color: #e2e8f0; height: 6px; border-radius: 99px; }
        .progress-fill { background-color: #7c3aed; height: 6px; border-radius: 99px; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3); }
        .fab:active { transform: scale(0.95); }
        .view-hidden { display: none; }
        
        /* Dynamic Sidebar */
        .dynamic-sidebar {
            width: 80px;
            transition: width 0.3s ease;
        }
        .dynamic-sidebar:hover {
            width: 240px;
        }
        .sidebar-label {
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .dynamic-sidebar:hover .sidebar-label {
            display: inline;
            opacity: 1;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #fff;
            width: 520px;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .modal-header h2 {
            margin: 0;
        }
        .close-btn {
            font-size: 22px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .subtitle {
            color: #6b7280;
            margin: 8px 0 20px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            font-weight: 600;
            font-size: 14px;
            display: block;
            margin-bottom: 6px;
        }
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .row {
            display: flex;
            gap: 14px;
        }
        .row .form-group {
            flex: 1;
        }
        .date-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }
        .today-btn {
            background: #ede9fe;
            color: #6d28d9;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .time-badge {
            background: #ede9fe;
            color: #6d28d9;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
        }
        .form-group input[type="range"] {
            width: 100%;
        }
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }
        .range-labels .active {
            color: #6d28d9;
            font-weight: 600;
        }
        .complexity {
            display: flex;
            gap: 12px;
        }
        .card {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .card h4 {
            margin: 0;
            font-size: 14px;
        }
        .card p {
            font-size: 13px;
            color: #6b7280;
            margin: 4px 0 0 0;
        }
        .card.active {
            border: 2px solid #6d28d9;
            background: #f5f3ff;
        }
        .modal-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            gap: 12px;
        }
        .modal-btn {
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            flex: 1;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .modal-btn:active {
            transform: translateY(0);
        }
        .modal-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            pointer-events: none;
        }
        .modal-btn:active::before {
            width: 300px;
            height: 300px;
        }
        .modal-btn.cancel {
            background: #f3f4f6;
        }
        .modal-btn.primary {
            background: linear-gradient(90deg, #7c3aed, #6366f1);
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Dashboard View -->
    <div id="dashboard-view" class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-sparkles"></i> <span>CodeCrux</span>
            </div>
            <div class="menu-section">
                <p class="menu-label">MENU</p>
                <a href="#" class="nav-item active" onclick="showView('dashboard'); return false;"><i class="fas fa-th-large"></i> Dashboard</a>
                <a href="#" class="nav-item" onclick="showView('courses'); return false;"><i class="fas fa-book"></i> My Courses</a>
                <a href="#" class="nav-item" onclick="showView('analytics'); return false;"><i class="fas fa-chart-line"></i> Analytics</a>
                <a href="#" class="nav-item" onclick="showView('labs'); return false;"><i class="fas fa-flask"></i> Practice Labs</a>
                <a href="#" class="nav-item" onclick="showView('exams'); return false;"><i class="fas fa-file-alt"></i> Exams</a>
            </div>
            <div class="bottom-menu">
                <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
                <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
                <a href="/logout/" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
            </div>
        </nav>

        <main class="main-content">
            <header class="top-header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search for courses, skills, or videos...">
                </div>
                <div class="header-actions">
                    <div class="notification-bell">
                        <i class="far fa-bell"></i>
                        <span class="dot"></span>
                    </div>
                    <div class="user-profile">
                        <div class="avatar">AM</div>
                        <div class="user-info">
                            <span class="user-name">Arka Maulana</span>
                            <span class="user-role">Student</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <div class="left-column">
                    <h2>Hello, Arka üëã</h2>
                    <p class="subtitle">Nice to have you back! You have <span class="highlight">4 exams</span> scheduled this week.</p>

                    <section class="focus-card">
                        <div class="focus-header">
                            <span>‚óè TODAY'S FOCUS</span>
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div id="today-focus-content" class="focus-content">
                            <div style="text-align:center; padding:20px; color:#9ca3af;">
                                <p>üìö No course in focus yet</p>
                                <p style="font-size:12px;">Generate or add a course to get started!</p>
                            </div>
                        </div>
                    </section>

                    <div class="section-header">
                        <h3>Your Courses <span class="count">(4)</span></h3>
                        <div class="filters">
                            <button class="active">All</button>
                            <button>Design</button>
                            <button>Science</button>
                            <button>Coding</button>
                        </div>
                    </div>

                    <div class="course-grid">
                        <div class="course-card" style="justify-content:center; align-items:center; text-align:center; padding:32px;">
                            <div class="card-body">
                                <span class="level beginner">No courses yet</span>
                                <h4>Add a course to get started</h4>
                                <p class="subtitle">Use ‚ÄúAdd Course‚Äù or ‚ÄúGenerate Course Curriculum‚Äù to build your plan.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <aside class="right-column">
                    <div class="user-stats-card">
                        <div class="avatar-large" id="user-avatar">AM</div>
                        <h4 id="user-name">Arka Maulana</h4>
                        <p id="user-role">Computer Science Student</p>
                        <div class="stats-row">
                            <div><strong id="total-courses">4</strong><span>COURSES</span></div>
                        </div>
                    </div>

                    <div class="xp-card">
                        <div class="xp-icon"><i class="fas fa-trophy"></i></div>
                        <h3>2,400 XP</h3>
                        <p>You're in the top 10% this week!</p>
                        <div class="xp-btns">
                            <button class="btn-outline">Redeem</button>
                            <button class="btn-solid">Collect</button>
                        </div>
                    </div>

                    <div class="activity-card">
                        <div class="focus-header">
                            <span>Learning Activity</span>
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="chart-placeholder" id="activity-chart-dashboard">
                            <svg viewBox="0 0 200 80">
                                <path d="M0,60 L40,55 L80,65 L120,40 L160,35 L200,45" fill="none" stroke="#6366f1" stroke-width="3"/>
                                <circle cx="160" cy="35" r="4" fill="#6366f1" />
                            </svg>
                            <div class="chart-label">0h</div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>
    </div>

    <!-- Courses View -->
    <div id="courses-view" class="view-hidden">
        <div class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-sparkles"></i> <span>CodeCrux</span>
            </div>
            <div class="menu-section">
                <p class="menu-label">MENU</p>
                <a href="#" class="nav-item" onclick="showView('dashboard'); return false;"><i class="fas fa-th-large"></i> Dashboard</a>
                <a href="#" class="nav-item active" onclick="showView('courses'); return false;"><i class="fas fa-book"></i> My Courses</a>
                <a href="#" class="nav-item" onclick="showView('analytics'); return false;"><i class="fas fa-chart-line"></i> Analytics</a>
                <a href="#" class="nav-item" onclick="showView('labs'); return false;"><i class="fas fa-flask"></i> Practice Labs</a>
                <a href="#" class="nav-item" onclick="showView('exams'); return false;"><i class="fas fa-file-alt"></i> Exams</a>
            </div>
            <div class="bottom-menu">
                <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
                <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
                <a href="/logout/" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
            </div>
        </nav>

        <main class="main-content">
            <header class="top-header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search for courses, skills, or videos...">
                </div>
                <div class="header-actions">
                    <div class="notification-bell">
                        <i class="far fa-bell"></i>
                        <span class="dot"></span>
                    </div>
                    <div class="user-profile">
                        <div class="avatar">AM</div>
                        <div class="user-info">
                            <span class="user-name">Arka Maulana</span>
                            <span class="user-role">Student</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <div class="left-column">
                    <h2>My Courses</h2>
                    <p class="subtitle">Here are all your courses</p>

                    <div id="courses-view-grid" class="course-grid">
                        <div class="bg-white rounded-[2rem] overflow-hidden card-shadow flex flex-col items-center justify-center text-center p-10 border border-dashed border-slate-200">
                            <i data-lucide="sparkles" class="w-10 h-10 text-indigo-400"></i>
                            <h3 class="mt-4 font-bold text-slate-800">No courses yet</h3>
                            <p class="text-sm text-slate-500 mt-2">Add a course or generate a curriculum to see it here.</p>
                            <button class="mt-4 px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold" onclick="openCourseModal()">Add Course</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        </div>
    </div>

    <!-- Analytics View -->
    <div id="analytics-view" class="view-hidden" style="background: #f6f7fb; min-height: 100vh;">
        <div class="dashboard-container">
            <nav class="sidebar">
                <div class="logo">
                    <i class="fas fa-sparkles"></i> <span>CodeCrux</span>
                </div>
                <div class="menu-section">
                    <p class="menu-label">MENU</p>
                    <a href="#" class="nav-item" onclick="showView('dashboard'); return false;"><i class="fas fa-th-large"></i> Dashboard</a>
                    <a href="#" class="nav-item" onclick="showView('courses'); return false;"><i class="fas fa-book"></i> My Courses</a>
                    <a href="#" class="nav-item active" onclick="showView('analytics'); return false;"><i class="fas fa-chart-line"></i> Analytics</a>
                    <a href="#" class="nav-item" onclick="showView('labs'); return false;"><i class="fas fa-flask"></i> Practice Labs</a>
                    <a href="#" class="nav-item" onclick="showView('exams'); return false;"><i class="fas fa-file-alt"></i> Exams</a>
                </div>
                <div class="bottom-menu">
                    <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
                    <a href="/logout/" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
                </div>
            </nav>

            <main class="main-content" style="flex: 1; padding: 0 30px; background: #f6f7fb;">
                <div style="max-width: 1400px; margin: 0 auto; padding: 30px 0;">
                    <!-- PAGE HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 40px;">
                        <div>
                            <h1 style="font-size: 32px; font-weight: 700; margin: 0; color: #1f2937;">Performance Analytics</h1>
                            <p style="color: #6b7280; margin: 8px 0 0 0; font-size: 15px;">Deep dive into your learning habits. Track your consistency, course completion rates, and exam performance over time.</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button style="padding: 8px 16px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Week</button>
                            <button style="padding: 8px 16px; background: #1f2937; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Month</button>
                            <button style="padding: 8px 16px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Year</button>
                        </div>
                    </div>

                    <!-- STAT CARDS -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 14px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Study Streak</p>
                                    <h2 style="font-size: 36px; font-weight: 700; margin: 8px 0 0 0;" id="analytics-streak-value">0</h2>
                                    <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">consecutive days</p>
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;" id="streak-change">+2 days</span>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; font-size: 12px;">üî• You're on fire!</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); padding: 24px; border-radius: 14px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Total Study Time</p>
                                    <h2 style="font-size: 36px; font-weight: 700; margin: 8px 0 0 0;" id="analytics-study-time-value">0h</h2>
                                    <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">this month</p>
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;" id="study-time-change">+12%</span>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; font-size: 12px;">‚è±Ô∏è Keep learning!</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 24px; border-radius: 14px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Avg Exam Score</p>
                                    <h2 style="font-size: 36px; font-weight: 700; margin: 8px 0 0 0;" id="analytics-exam-score">0%</h2>
                                    <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">performance</p>
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;" id="exam-score-change">+3%</span>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; font-size: 12px;">üìà Excellent progress</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); padding: 24px; border-radius: 14px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Modules Done</p>
                                    <h2 style="font-size: 36px; font-weight: 700; margin: 8px 0 0 0;" id="analytics-modules-value">0</h2>
                                    <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">completed</p>
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">+5%</span>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; font-size: 12px;">‚úÖ Stay consistent</div>
                        </div>
                    </div>

                    <!-- CHARTS ROW -->
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 40px;">
                        <!-- Learning Trends -->
                        <div style="background: #ffffff; padding: 28px; border-radius: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1f2937;">Learning Trends</h3>
                                    <p style="color: #9ca3af; font-size: 12px; margin: 4px 0 0 0; text-transform: uppercase;">Last 7 Days Activity</p>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
                                        <div style="width: 3px; height: 16px; background: #6366f1; border-radius: 2px;"></div>
                                        <span style="color: #6b7280;">Study Hours</span>
                                    </div>
                                </div>
                            </div>
                            <svg viewBox="0 0 800 250" style="width: 100%; height: 200px;">
                                <defs>
                                    <linearGradient id="trendGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:0.3" />
                                        <stop offset="100%" style="stop-color:#6366f1;stop-opacity:0.01" />
                                    </linearGradient>
                                </defs>
                                <g style="opacity: 0.1;">
                                    <line x1="0" y1="60" x2="800" y2="60" stroke="#e5e7eb" stroke-width="1"/>
                                    <line x1="0" y1="120" x2="800" y2="120" stroke="#e5e7eb" stroke-width="1"/>
                                    <line x1="0" y1="180" x2="800" y2="180" stroke="#e5e7eb" stroke-width="1"/>
                                </g>
                                <polyline id="trend-polyline" points="0,150 120,120 240,100 360,80 480,110 600,90 720,50" fill="none" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                <polygon id="trend-polygon" points="0,150 120,120 240,100 360,80 480,110 600,90 720,50 720,250 0,250" fill="url(#trendGrad)"/>
                                <circle cx="120" cy="120" r="5" fill="#6366f1"/>
                                <circle cx="240" cy="100" r="5" fill="#6366f1"/>
                                <circle cx="360" cy="80" r="5" fill="#6366f1"/>
                                <circle cx="480" cy="110" r="5" fill="#6366f1"/>
                                <circle cx="600" cy="90" r="5" fill="#6366f1"/>
                                <circle cx="720" cy="50" r="5" fill="#6366f1" style="filter: drop-shadow(0 0 6px rgba(99, 102, 241, 0.4));"/>
                            </svg>
                        </div>

                        <!-- Performance Stats -->
                        <div style="background: #ffffff; padding: 28px; border-radius: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                            <h3 style="margin: 0 0 24px 0; font-size: 18px; font-weight: 700; color: #1f2937;">Performance Metrics</h3>
                            
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #6b7280; font-weight: 600;">Focus Level</span>
                                    <span style="font-size: 13px; color: #6366f1; font-weight: 600;" id="focus-level">75%</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 75%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 4px;"></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #6b7280; font-weight: 600;">Engagement</span>
                                    <span style="font-size: 13px; color: #10b981; font-weight: 600;" id="engagement-level">82%</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 82%; background: linear-gradient(90deg, #10b981, #6ee7b7); border-radius: 4px;"></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #6b7280; font-weight: 600;">Completion Rate</span>
                                    <span style="font-size: 13px; color: #f59e0b; font-weight: 600;" id="completion-rate">0%</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div id="completion-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 4px;"></div>
                                </div>
                            </div>

                            <div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">
                                <p style="font-size: 12px; color: #9ca3af; margin: 0;"><strong style="color: #6b7280;">Quick Tip:</strong> Maintain your daily streak by studying for at least 1 hour daily.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PROGRESS & CONSISTENCY -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                        <!-- Course Breakdown -->
                        <div style="background: #ffffff; padding: 28px; border-radius: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                            <h3 style="margin: 0 0 24px 0; font-size: 18px; font-weight: 700; color: #1f2937;">Course Progress</h3>
                            <div id="course-progress-bars" style="display: flex; align-items: flex-end; gap: 12px; height: 140px; justify-content: space-around;">
                                <!-- Filled dynamically -->
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 100%; height: 40%; background: #e5e7eb; border-radius: 4px; margin-bottom: 8px;"></div>
                                    <span style="font-size: 11px; color: #9ca3af;">Course</span>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                                    <span id="courses-total">Total: 0 courses</span>
                                    <span id="courses-active">Active: 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Consistency Heatmap -->
                        <div style="background: #ffffff; padding: 28px; border-radius: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1f2937;">Consistency Tracker</h3>
                                <span style="font-size: 12px; color: #9ca3af;" id="consistency-month">January 2026</span>
                            </div>
                            <p style="color: #9ca3af; font-size: 12px; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">Daily Contribution</p>
                            <div id="consistency-grid" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; margin-bottom: 20px;">
                                <!-- Filled dynamically -->
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: #9ca3af; padding: 12px 0; border-top: 1px solid #e5e7eb;">
                                <span>Less</span>
                                <div style="display: flex; gap: 4px;">
                                    <div style="width: 12px; height: 12px; background: #e5e7eb; border-radius: 3px;"></div>
                                    <div style="width: 12px; height: 12px; background: #c7d2fe; border-radius: 3px;"></div>
                                    <div style="width: 12px; height: 12px; background: #818cf8; border-radius: 3px;"></div>
                                    <div style="width: 12px; height: 12px; background: #6366f1; border-radius: 3px;"></div>
                                    <div style="width: 12px; height: 12px; background: #4f46e5; border-radius: 3px;"></div>
                                </div>
                                <span>More</span>
                            </div>
                            <p style="font-size: 11px; color: #9ca3af; margin: 12px 0 0 0; text-align: right;">Updated today at <span id="update-time">12:30 PM</span></p>
                        </div>
                    </div>

                    <!-- DETAILED STATS -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 14px; color: white;">
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase;">Weekly Average</p>
                            <h2 style="font-size: 28px; font-weight: 700; margin: 8px 0 0 0;" id="weekly-avg">0h</h2>
                            <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">per day</p>
                        </div>

                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 14px; color: white;">
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase;">This Month</p>
                            <h2 style="font-size: 28px; font-weight: 700; margin: 8px 0 0 0;" id="monthly-total">0h</h2>
                            <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">total study time</p>
                        </div>

                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 14px; color: white;">
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 0; text-transform: uppercase;">Best Day</p>
                            <h2 style="font-size: 28px; font-weight: 700; margin: 8px 0 0 0;" id="best-day">0h</h2>
                            <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0 0;">your peak</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Practice Labs View -->
    <div id="labs-view" class="view-hidden" style="background: #f6f7fb; min-height: 100vh;">
        <div class="dashboard-container">
            <nav class="sidebar">
                <div class="logo">
                    <i class="fas fa-sparkles"></i> <span>CodeCrux</span>
                </div>
                <div class="menu-section">
                    <p class="menu-label">MENU</p>
                    <a href="#" class="nav-item" onclick="showView('dashboard'); return false;"><i class="fas fa-th-large"></i> Dashboard</a>
                    <a href="#" class="nav-item" onclick="showView('courses'); return false;"><i class="fas fa-book"></i> My Courses</a>
                    <a href="#" class="nav-item" onclick="showView('analytics'); return false;"><i class="fas fa-chart-line"></i> Analytics</a>
                    <a href="#" class="nav-item" onclick="showView('labs'); return false;"><i class="fas fa-flask"></i> Practice Labs</a>
                    <a href="#" class="nav-item" onclick="showView('exams'); return false;"><i class="fas fa-file-alt"></i> Exams</a>
                </div>
                <div class="bottom-menu">
                    <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
                    <a href="/logout/" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
                </div>
            </nav>

            <main class="main-content" style="flex: 1; padding: 0; background: #f6f7fb; display: flex; height: calc(100vh - 0px); overflow: hidden;">
                <!-- LEFT SIDE - PROBLEM STATEMENT (50%) -->
                <div style="width: 50%; background: #ffffff; overflow-y: auto; border-right: 1px solid #e5e7eb;">
                    <div style="padding: 30px;">
                        <!-- PROBLEM HEADER -->
                        <div style="margin-bottom: 24px;">
                            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 12px 0; color: #1f2937;" id="dsa-question-title">Two Sum</h1>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                <span style="background: #dbeafe; color: #0369a1; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;" id="dsa-difficulty">Medium</span>
                                <span style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;" id="dsa-category">Arrays</span>
                            </div>
                            <p style="color: #9ca3af; margin: 0; font-size: 13px;" id="dsa-question-date">Today's Question ‚Ä¢ Updates daily at 12:00 AM</p>
                        </div>

                        <!-- PROBLEM STATEMENT -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #1f2937;">Problem Statement</h3>
                            <p style="margin: 0; color: #4b5563; font-size: 14px; line-height: 1.7;" id="dsa-problem">Given an array of integers nums and an integer target, return the indices of the two numbers that add up to the target. You may assume that each input has exactly one solution, and you may not use the same element twice.</p>
                        </div>

                        <!-- EXAMPLES -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #1f2937;">Example</h3>
                            <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 3px solid #6366f1; margin-bottom: 12px;">
                                <p style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151;">Input:</p>
                                <pre style="margin: 0; color: #6b7280; font-size: 13px; font-family: monospace; background: #1f2937; padding: 12px; border-radius: 6px; color: #10b981; overflow-x: auto;" id="dsa-input">nums = [2, 7, 11, 15], target = 9</pre>
                            </div>
                            <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 3px solid #10b981;">
                                <p style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151;">Output:</p>
                                <pre style="margin: 0; color: #6b7280; font-size: 13px; font-family: monospace; background: #1f2937; padding: 12px; border-radius: 6px; color: #ef4444; overflow-x: auto;" id="dsa-output">[0, 1]</pre>
                            </div>
                        </div>

                        <!-- CONSTRAINTS -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #1f2937;">Constraints</h3>
                            <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 14px; line-height: 1.8;">
                                <li>2 ‚â§ nums.length ‚â§ 10‚Å¥</li>
                                <li>-10‚Åπ ‚â§ nums[i] ‚â§ 10‚Åπ</li>
                                <li>-10‚Åπ ‚â§ target ‚â§ 10‚Åπ</li>
                                <li>Only one valid answer exists</li>
                            </ul>
                        </div>

                        <!-- HINTS -->
                        <div>
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #1f2937;">üí° Hints</h3>
                            <details style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                                <summary style="font-size: 13px; font-weight: 600; color: #92400e;">Hint 1</summary>
                                <p style="margin: 8px 0 0 0; font-size: 13px; color: #78350f;">Try using a hash map to store the numbers you've seen so far.</p>
                            </details>
                            <details style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; cursor: pointer;">
                                <summary style="font-size: 13px; font-weight: 600; color: #92400e;">Hint 2</summary>
                                <p style="margin: 8px 0 0 0; font-size: 13px; color: #78350f;">For each number, check if (target - current number) exists in the hash map.</p>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDE - CODE EDITOR (50%) -->
                <div style="width: 50%; background: #1e1e1e; display: flex; flex-direction: column;">
                    <!-- EDITOR HEADER -->
                    <div style="background: #2d2d30; padding: 12px 20px; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: #cccccc;">Code Editor</h3>
                        <select id="labs-language" style="padding: 6px 12px; border: 1px solid #3e3e42; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1e1e1e; color: #cccccc; cursor: pointer;">
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="c">C</option>
                            <option value="cpp">C++</option>
                        </select>
                    </div>

                    <!-- CODE TEXTAREA -->
                    <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <textarea id="labs-code-input" style="flex: 1; width: 100%; padding: 16px; border: none; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 14px; resize: none; background: #1e1e1e; color: #d4d4d4; line-height: 1.6; outline: none;" placeholder="// Write your solution here
function twoSum(nums, target) {
    // Your code here
}"></textarea>
                    </div>

                    <!-- OUTPUT SECTION -->
                    <div style="height: 200px; background: #252526; border-top: 1px solid #3e3e42; display: flex; flex-direction: column;">
                        <div style="background: #2d2d30; padding: 8px 20px; border-bottom: 1px solid #3e3e42;">
                            <span style="font-size: 13px; font-weight: 600; color: #cccccc;">Output</span>
                        </div>
                        <div id="labs-output" style="flex: 1; padding: 12px 20px; color: #10b981; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
                            <p style="color: #858585; margin: 0;">Output will appear here...</p>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div style="background: #2d2d30; padding: 12px 20px; border-top: 1px solid #3e3e42; display: flex; gap: 12px;">
                        <button onclick="executeLabCode()" style="flex: 1; padding: 10px; background: #0e639c; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s;">‚ñ∂ Run Code</button>
                        <button onclick="submitLabCode()" style="flex: 1; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s;">‚úì Submit</button>
                        <button onclick="openDataStructureAR()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #0ea5e9, #6366f1); color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.3s;">üï∂Ô∏è Visualize DS</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- EXAMS VIEW -->
    <div id="exams-view" class="view-hidden" style="background: #f6f7fb; min-height: 100vh;">
        <div class="dashboard-container">
            <!-- SIDEBAR -->
            <nav class="sidebar">
                <div class="logo">
                    <i class="fas fa-sparkles"></i> <span>CodeCrux</span>
                </div>
                <div class="menu-section">
                    <p class="menu-label">MENU</p>
                    <a href="#" class="nav-item" onclick="showView('dashboard'); return false;"><i class="fas fa-th-large"></i> Dashboard</a>
                    <a href="#" class="nav-item" onclick="showView('courses'); return false;"><i class="fas fa-book"></i> My Courses</a>
                    <a href="#" class="nav-item" onclick="showView('analytics'); return false;"><i class="fas fa-chart-line"></i> Analytics</a>
                    <a href="#" class="nav-item" onclick="showView('labs'); return false;"><i class="fas fa-flask"></i> Practice Labs</a>
                    <a href="#" class="nav-item active" onclick="showView('exams'); return false;"><i class="fas fa-file-alt"></i> Exams</a>
                </div>
                <div class="bottom-menu">
                    <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
                    <a href="/logout/" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
                </div>
            </nav>

            <!-- MAIN CONTENT -->
            <main class="main-content">
                <!-- PAGE HEADER -->
                <div style="padding: 24px 32px; border-bottom: 1px solid #e5e7eb; background: white;">
                    <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: #1f2937;">Examinations</h2>
                    <p style="margin: 0; font-size: 14px; color: #6b7280;">View upcoming assessments, check your eligibility, and review past performance.</p>
                </div>

                <!-- CONTROLS SECTION -->
                <div style="padding: 24px 32px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <!-- TABS -->
                    <div style="display: flex; gap: 0; border-bottom: 2px solid #e5e7eb;">
                        <button onclick="switchExamTab('upcoming')" id="tab-upcoming" style="padding: 12px 24px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #667eea; cursor: pointer; border-bottom: 2px solid #667eea; transition: all 0.3s;">Upcoming</button>
                        <button onclick="switchExamTab('history')" id="tab-history" style="padding: 12px 24px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #9ca3af; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s;">History</button>
                    </div>

                    <!-- SEARCH BAR -->
                    <input type="text" placeholder="Search exams..." style="padding: 10px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; width: 200px; flex: 1; max-width: 300px; outline: none; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">

                    <!-- SORT OPTIONS -->
                    <div style="margin-left: auto; display: flex; gap: 12px;">
                        <select style="padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; color: #6b7280; cursor: pointer; outline: none;">
                            <option>Sort by Date</option>
                            <option>Upcoming</option>
                            <option>Recent</option>
                        </select>
                        <select style="padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; color: #6b7280; cursor: pointer; outline: none;">
                            <option>All Exams</option>
                            <option>Certification</option>
                            <option>Practice</option>
                        </select>
                    </div>
                </div>

                <!-- EXAMS GRID (EMPTY) -->
                <div id="exams-container" style="padding: 32px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                    <div style="grid-column: 1/-1; text-align: center; color: #9ca3af;">
                        <i style="font-size: 48px; margin-bottom: 16px; display: block; color: #d1d5db;">üìã</i>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #6b7280;">No Exams Available</h3>
                        <p style="margin: 0; font-size: 14px; color: #9ca3af;">Check back soon for upcoming examinations.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <button class="fab fixed bottom-8 right-8 w-14 h-14 text-white rounded-2xl flex items-center justify-center shadow-2xl transition-all duration-300 z-[999]" style="background-color: #1a1c3d; font-size: 28px; font-weight: bold;" onclick="openCourseModal()">
        +
    </button>

    <!-- Create Course Modal -->
    <div id="courseModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Create New Course</h2>
                <button class="close-btn" onclick="closeCourseModal()">&times;</button>
            </div>
            <p class="subtitle">Transform any YouTube content into a structured course.</p>

            <!-- Basic Info -->
            <div class="form-group">
                <label>Course Title</label>
                <input id="course-title-input" type="text" placeholder="e.g., React Core Concepts" />
            </div>

            <div class="form-group">
                <label>YouTube Course Link</label>
                <input id="course-link-input" type="text" placeholder="https://www.youtube.com/watch?v=..." />
            </div>

            <!-- Category & Date -->
            <div class="row">
                <div class="form-group">
                    <label>Category</label>
                    <select>
                        <option>Computer Science</option>
                        <option>Data Science</option>
                        <option>AI & ML</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Start Date</label>
                    <div class="date-box">
                        <span>Sun, Dec 28</span>
                        <button class="today-btn" type="button">Today</button>
                    </div>
                </div>
            </div>

            <!-- Daily Goal -->
            <div class="form-group">
                <label>Daily Goal</label>
                <div class="goal-header">
                    <span>How much time can you dedicate daily?</span>
                    <span class="time-badge">1.5 hrs</span>
                </div>
                <input id="study-minutes-input" type="range" min="30" max="180" step="30" value="90" />
                <div class="range-labels">
                    <span>30 min</span>
                    <span>1 hr</span>
                    <span class="active">1.5 hrs</span>
                    <span>2 hrs</span>
                    <span>2.5 hrs</span>
                    <span>3 hrs</span>
                </div>
            </div>

            <!-- Complexity -->
            <div class="form-group">
                <label>Complexity</label>
                <div class="complexity">
                    <div class="card active" onclick="selectComplexity(this)">
                        <h4>Beginner</h4>
                        <p>New to the subject</p>
                    </div>
                    <div class="card" onclick="selectComplexity(this)">
                        <h4>Intermediate</h4>
                        <p>Some prior knowledge</p>
                    </div>
                    <div class="card" onclick="selectComplexity(this)">
                        <h4>Advanced</h4>
                        <p>Deep understanding</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeCourseModal()">Cancel</button>
                <button id="generate-curriculum-btn" class="modal-btn primary">‚ö° Generate Course Curriculum</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/studymate/api';

        function showView(viewName) {
            const dashboardView = document.getElementById('dashboard-view');
            const coursesView = document.getElementById('courses-view');
            const analyticsView = document.getElementById('analytics-view');
            const labsView = document.getElementById('labs-view');
            const examsView = document.getElementById('exams-view');
            const fab = document.querySelector('.fab');
            
            // Hide all views
            dashboardView.classList.add('view-hidden');
            coursesView.classList.add('view-hidden');
            analyticsView.classList.add('view-hidden');
            labsView.classList.add('view-hidden');
            examsView.classList.add('view-hidden');
            
            // Show selected view
            if (viewName === 'dashboard') {
                dashboardView.classList.remove('view-hidden');
                fab.style.display = 'flex';
            } else if (viewName === 'courses') {
                coursesView.classList.remove('view-hidden');
                fab.style.display = 'flex';
            } else if (viewName === 'analytics') {
                analyticsView.classList.remove('view-hidden');
                updateAnalyticsData();
                fab.style.display = 'flex';
            } else if (viewName === 'labs') {
                labsView.classList.remove('view-hidden');
                updateLabsData();
                fab.style.display = 'flex';
            } else if (viewName === 'exams') {
                examsView.classList.remove('view-hidden');
                loadStudentExams();
                fab.style.display = 'none';
            }
            
            // Update active nav items in all sidebars
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item')?.classList.add('active');
        }

        // Load student exams from backend
        let currentExamTab = 'upcoming';
        let studentExamsData = { upcoming_exams: [], completed_exams: [] };
        
        async function loadStudentExams() {
            const DJANGO_API = 'http://127.0.0.1:786';
            
            console.log('üîç Loading student exams...');
            
            // Try to get roll number from localStorage or fetch it
            let rollNumber = localStorage.getItem('studentRollNumber');
            console.log('üìã Roll number from localStorage:', rollNumber);
            
            if (!rollNumber) {
                console.log('‚ö†Ô∏è No roll number in localStorage, fetching student info...');
                // Try to fetch roll number from student API
                try {
                    const studentResponse = await fetch(`${API_BASE_URL}/get-current-student/`);
                    if (studentResponse.ok) {
                        const student = await studentResponse.json();
                        rollNumber = student.roll_number;
                        if (rollNumber) {
                            localStorage.setItem('studentRollNumber', rollNumber);
                            console.log('‚úÖ Stored student roll number:', rollNumber);
                        } else {
                            console.warn('‚ö†Ô∏è Student info received but no roll_number:', student);
                        }
                    }
                } catch (e) {
                    console.log('‚ùå Could not get student info:', e);
                }
            }
            
            if (!rollNumber) {
                console.log('‚ùå No roll number found - cannot load exams');
                renderExams(); // Show empty state
                return;
            }
            
            console.log('üì° Loading exams for roll number:', rollNumber);
            
            try {
                const url = `${DJANGO_API}/api/student/exams/${rollNumber}/`;
                console.log('üì° Fetching exams from:', url);
                const response = await fetch(url);
                console.log('üì° Exams API response status:', response.status);
                
                const data = await response.json();
                
                console.log('üìã Exams API response:', data);
                
                if (data.upcoming || data.completed) {
                    studentExamsData = data;
                    console.log('‚úÖ Exams loaded. Upcoming:', (data.upcoming || []).length, 'Completed:', (data.completed || []).length);
                    renderExams();
                } else if (data.upcoming_exams || data.completed_exams) {
                    // Backward compatibility if API returns older keys
                    studentExamsData = {
                        upcoming: data.upcoming_exams || [],
                        completed: data.completed_exams || []
                    };
                    console.log('‚úÖ Exams loaded (legacy format). Upcoming:', studentExamsData.upcoming.length, 'Completed:', studentExamsData.completed.length);
                    renderExams();
                } else if (data.error) {
                    console.error('‚ùå Exams API error:', data.error);
                    renderExams();
                }
            } catch (error) {
                console.error('Error loading exams:', error);
                renderExams();
            }
        }

        // Load user stats (courses and certificates)
        async function loadUserStats() {
            try {
                const DJANGO_API = 'http://127.0.0.1:786';
                let rollNumber = localStorage.getItem('studentRollNumber');
                
                if (!rollNumber) {
                    // Try to fetch from student API
                    const studentResponse = await fetch(`${API_BASE_URL}/get-current-student/`);
                    if (studentResponse.ok) {
                        const student = await studentResponse.json();
                        rollNumber = student.roll_number;
                        if (rollNumber) {
                            localStorage.setItem('studentRollNumber', rollNumber);
                        }
                    }
                }

                if (!rollNumber) {
                    console.warn('‚ö†Ô∏è Could not determine roll number for stats');
                    return;
                }

                // Fetch student courses
                const coursesResponse = await fetch(`${DJANGO_API}/api/student/courses/${rollNumber}/`);
                if (coursesResponse.ok) {
                    const coursesData = await coursesResponse.json();
                    const courseCount = coursesData.length || 0;
                    document.getElementById('total-courses').textContent = courseCount;
                    console.log('‚úÖ Loaded courses count:', courseCount);
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch courses data');
                }

                // Fetch student info for user details
                const studentResponse = await fetch(`${DJANGO_API}/api/student/${rollNumber}/`);
                if (studentResponse.ok) {
                    const student = await studentResponse.json();
                    
                    // Update user name
                    const fullName = student.first_name ? `${student.first_name} ${student.last_name || ''}`.trim() : 'Student';
                    document.getElementById('user-name').textContent = fullName;
                    
                    // Update avatar initials
                    const initials = (student.first_name?.charAt(0) || 'S') + (student.last_name?.charAt(0) || 'T');
                    document.getElementById('user-avatar').textContent = initials.toUpperCase();
                    
                    // Update user role
                    const role = student.user_type === 'student' ? 'Student' : 'User';
                    const department = student.branch || 'Engineering';
                    document.getElementById('user-role').textContent = `${department} ${role}`;
                    
                    console.log('‚úÖ Loaded user info:', fullName);
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch student data');
                }

            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadUserStats();
        });
        
        function renderExams() {
            const container = document.getElementById('exams-container');
            const exams = currentExamTab === 'upcoming' ? (studentExamsData.upcoming || []) : (studentExamsData.completed || []);
            
            if (!exams || exams.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #9ca3af; padding: 60px;">
                        <i style="font-size: 48px; margin-bottom: 16px; display: block; color: #d1d5db;">üìã</i>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #6b7280;">
                            ${currentExamTab === 'upcoming' ? 'No Upcoming Exams' : 'No Exam History'}
                        </h3>
                        <p style="margin: 0; font-size: 14px; color: #9ca3af;">
                            ${currentExamTab === 'upcoming' ? 'Check back soon for new examinations.' : 'Your completed exams will appear here.'}
                        </p>
                    </div>
                `;
                container.style.display = 'flex';
                return;
            }
            
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(350px, 1fr))';
            
            container.innerHTML = exams.map(exam => {
                const difficultyColor = exam.difficulty === 'easy' ? '#10b981' : exam.difficulty === 'hard' ? '#ef4444' : '#f59e0b';
                const difficultyBg = exam.difficulty === 'easy' ? '#d1fae5' : exam.difficulty === 'hard' ? '#fee2e2' : '#fef3c7';
                
                // Parse the scheduled_date - handle both ISO format and other formats
                let scheduledDate = 'Not scheduled';
                if (exam.scheduled_date) {
                    try {
                        // If it's ISO format with timezone, parse it correctly
                        const dateObj = new Date(exam.scheduled_date);
                        
                        // Check if date is valid
                        if (!isNaN(dateObj.getTime())) {
                            scheduledDate = dateObj.toLocaleString('en-US', {
                                weekday: 'short',
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing scheduled_date:', exam.scheduled_date, e);
                        scheduledDate = exam.scheduled_date;
                    }
                }
                
                if (currentExamTab === 'upcoming') {
                    // Calculate exam timing status
                    const now = new Date();
                    const scheduledDateTime = exam.scheduled_date ? new Date(exam.scheduled_date) : null;
                    const endDateTime = exam.end_date ? new Date(exam.end_date) : null;

                    // Detect prior attempts from backend or local cache to prevent re-entry
                    const localAttempt = localStorage.getItem(`exam_attempted_${exam.id}`);
                    const attemptStatus = exam.attempt_status || localAttempt || null;
                    const isSubmitted = attemptStatus === 'submitted' || attemptStatus === 'completed' || attemptStatus === 'evaluated';
                    const isBlocked = attemptStatus === 'blocked';
                    const hasAttempted = isSubmitted || isBlocked;
                    
                    let examStatus = 'not-started'; // not-started, active, ended
                    let canStartExam = true;
                    let statusMessage = '';
                    
                    if (hasAttempted) {
                        examStatus = isBlocked ? 'blocked' : 'submitted';
                        canStartExam = false;
                        statusMessage = isBlocked ? 'Blocked' : 'Submitted';
                    } else if (scheduledDateTime) {
                        if (now < scheduledDateTime) {
                            examStatus = 'not-started';
                            canStartExam = false;
                            // Calculate countdown
                            const timeUntilExam = scheduledDateTime - now;
                            const hours = Math.floor(timeUntilExam / (1000 * 60 * 60));
                            const minutes = Math.floor((timeUntilExam % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((timeUntilExam % (1000 * 60)) / 1000);
                            statusMessage = `Starts in ${hours}h ${minutes}m ${seconds}s`;
                        } else if (endDateTime && now > endDateTime) {
                            examStatus = 'ended';
                            canStartExam = false;
                            statusMessage = 'Exam has ended';
                        } else {
                            examStatus = 'active';
                            canStartExam = true;
                            statusMessage = 'Available Now';
                        }
                    }
                    
                    const buttonColor = canStartExam ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#cbd5e1';
                    const buttonCursor = canStartExam ? 'pointer' : 'not-allowed';
                    const buttonLabel = hasAttempted ? (isBlocked ? 'Blocked' : 'Submitted') : (canStartExam ? 'Start Exam' : 'Not Available');
                    const statusColor = hasAttempted ? (isBlocked ? '#ef4444' : '#10b981') : (canStartExam ? '#10b981' : '#f59e0b');
                    
                    return `
                        <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)';">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <span style="background: ${difficultyBg}; color: ${difficultyColor}; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${exam.difficulty}</span>
                                    ${exam.is_proctored ? '<span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 11px;"><i class="fas fa-video" style="margin-right: 4px;"></i>Proctored</span>' : ''}
                                </div>
                                <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700;">${exam.title}</h3>
                                <p style="margin: 0; font-size: 13px; opacity: 0.9;">${exam.course_title || exam.topic || 'General Assessment'}</p>
                            </div>
                            <div style="padding: 24px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                                    <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                                        <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${exam.total_questions}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Questions</div>
                                    </div>
                                    <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                                        <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${exam.duration_minutes}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Minutes</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                                    ${exam.mcq_count > 0 ? `<span style="background: #dbeafe; color: #1d4ed8; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">${exam.mcq_count} MCQ</span>` : ''}
                                    ${exam.coding_count > 0 ? `<span style="background: #ede9fe; color: #6d28d9; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">${exam.coding_count} Coding</span>` : ''}
                                    <span style="background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">${exam.total_marks} Marks</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; color: #6b7280; font-size: 13px; margin-bottom: 20px;">
                                    <i class="fas fa-calendar"></i>
                                    <span>${scheduledDate}</span>
                                </div>
                                <div style="text-align: center; margin-bottom: 16px;">
                                    <span style="font-size: 13px; font-weight: 600; color: ${statusColor};" id="countdown-${exam.id}">${statusMessage}</span>
                                </div>
                                <button ${canStartExam ? `onclick="startExam(${exam.id})"` : ''} style="width: 100%; padding: 14px; background: ${buttonColor}; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: ${buttonCursor}; transition: all 0.3s; opacity: ${canStartExam ? '1' : '0.6'};" ${!canStartExam ? 'disabled' : ''} onmouseover="${canStartExam ? "this.style.transform='scale(1.02)'" : ''}" onmouseout="${canStartExam ? "this.style.transform=''" : ''}">
                                    <i class="fas fa-play" style="margin-right: 8px;"></i>${buttonLabel}
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Completed exam card
                    const passed = exam.passed;
                    const statusColor = passed ? '#10b981' : '#ef4444';
                    const statusBg = passed ? '#d1fae5' : '#fee2e2';
                    
                    return `
                        <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1f2937;">${exam.title}</h3>
                                    <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">${passed ? 'Passed' : 'Failed'}</span>
                                </div>
                                <p style="margin: 0; font-size: 13px; color: #6b7280;">${exam.course_title || exam.topic || 'General Assessment'}</p>
                            </div>
                            <div style="padding: 24px;">
                                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                    <div style="width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(${statusColor} ${exam.percentage || 0}%, #e5e7eb 0%); display: flex; align-items: center; justify-content: center;">
                                        <div style="width: 80px; height: 80px; border-radius: 50%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                            <span style="font-size: 24px; font-weight: 700; color: ${statusColor};">${Math.round(exam.percentage || 0)}%</span>
                                            <span style="font-size: 11px; color: #6b7280;">Score</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                                    <div>
                                        <div style="font-size: 16px; font-weight: 700; color: #1f2937;">${exam.score || 0}</div>
                                        <div style="font-size: 11px; color: #6b7280;">Marks Obtained</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 16px; font-weight: 700; color: #1f2937;">${exam.total_marks}</div>
                                        <div style="font-size: 11px; color: #6b7280;">Total Marks</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 16px; font-weight: 700; color: #1f2937;">${exam.passing_marks}</div>
                                        <div style="font-size: 11px; color: #6b7280;">Passing</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            // Initialize countdowns for exams that haven't started yet
            initializeCountdowns(exams);
        }

        function switchExamTab(tabName) {
            currentExamTab = tabName;
            // Update tab button styles
            document.getElementById('tab-upcoming').style.color = tabName === 'upcoming' ? '#667eea' : '#9ca3af';
            document.getElementById('tab-upcoming').style.borderBottomColor = tabName === 'upcoming' ? '#667eea' : 'transparent';
            document.getElementById('tab-history').style.color = tabName === 'history' ? '#667eea' : '#9ca3af';
            document.getElementById('tab-history').style.borderBottomColor = tabName === 'history' ? '#667eea' : 'transparent';
            renderExams();
        }
        
        // Store countdown intervals globally to clean them up
        const countdownIntervals = {};
        
        function initializeCountdowns(exams) {
            // Initialize countdowns for any exam not yet started
            exams.forEach(exam => {
                if (currentExamTab === 'upcoming' && exam.scheduled_date && exam.end_date) {
                    const now = new Date();
                    const scheduledDate = new Date(exam.scheduled_date);
                    if (now < scheduledDate) {
                        updateCountdown(exam.id, exam.scheduled_date, exam.end_date);
                    }
                }
            });
        }
        
        function updateCountdown(examId, scheduledDateStr, endDateStr) {
            const countdownElement = document.getElementById(`countdown-${examId}`);
            if (!countdownElement) return;
            
            // Clear any existing interval for this exam
            if (countdownIntervals[examId]) {
                clearInterval(countdownIntervals[examId]);
            }
            
            // Update countdown every second
            const updateTimer = () => {
                const now = new Date();
                const scheduledDate = new Date(scheduledDateStr);
                const endDate = new Date(endDateStr);
                
                if (now < scheduledDate) {
                    // Exam hasn't started yet
                    const timeUntilExam = scheduledDate - now;
                    const hours = Math.floor(timeUntilExam / (1000 * 60 * 60));
                    const minutes = Math.floor((timeUntilExam % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeUntilExam % (1000 * 60)) / 1000);
                    
                    countdownElement.textContent = `Starts in ${hours}h ${minutes}m ${seconds}s`;
                    countdownElement.style.color = '#f59e0b'; // Orange
                } else if (now > endDate) {
                    // Exam has ended
                    countdownElement.textContent = 'Exam has ended';
                    countdownElement.style.color = '#ef4444'; // Red
                    clearInterval(countdownIntervals[examId]);
                } else {
                    // Exam is active
                    countdownElement.textContent = 'Available Now';
                    countdownElement.style.color = '#10b981'; // Green
                    clearInterval(countdownIntervals[examId]);
                }
            };
            
            // Run immediately
            updateTimer();
            
            // Then run every second
            countdownIntervals[examId] = setInterval(updateTimer, 1000);
        }
        
        function startExam(examId) {
            // Navigate to proctored exam page through Django
            window.location.href = `http://localhost:786/studymate/exam/?id=${examId}`;
        }

        function updateAnalyticsData() {
            // Get learning sessions data
            const sessions = JSON.parse(localStorage.getItem('learningSessions') || '{}');
            const courses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
            const today = new Date();
            
            // Calculate total study time
            const totalMinutes = Object.values(sessions).reduce((a, b) => a + b, 0);
            const totalHours = (totalMinutes / 60).toFixed(1);
            document.getElementById('analytics-study-time-value').textContent = totalHours + 'h';
            
            // Calculate study streak
            let streak = 0;
            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                if (sessions[dateStr]) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }
            document.getElementById('analytics-streak-value').textContent = streak;
            
            // Calculate modules completed
            const totalModules = courses.reduce((sum, c) => sum + (c.dailyPlan?.length || 0), 0);
            const completedModules = courses.reduce((sum, c) => {
                const plan = c.dailyPlan || [];
                return sum + plan.filter(m => m.completed).length;
            }, 0);
            document.getElementById('analytics-modules-value').textContent = completedModules;
            
            // Calculate exam score from actual exam data only
            const examScores = JSON.parse(localStorage.getItem('examScores') || '[]');
            let examScore = 0;
            if (examScores.length > 0) {
                // Calculate average of all exam scores
                const totalScore = examScores.reduce((sum, scoreObj) => {
                    return sum + (scoreObj.score || scoreObj);
                }, 0);
                examScore = Math.round(totalScore / examScores.length);
            }
            // If no exams taken, score is 0
            document.getElementById('analytics-exam-score').textContent = examScore + '%';
            
            // Update completion rate bar
            const completionPercentage = totalModules > 0 ? (completedModules / totalModules) * 100 : 0;
            document.getElementById('completion-rate').textContent = Math.round(completionPercentage) + '%';
            document.getElementById('completion-bar').style.width = completionPercentage + '%';
            
            // Update performance metrics
            const focusLevel = Math.min(100, Math.round((totalMinutes / 300) * 100)); // 300 mins = 100%
            const engagementLevel = Math.min(100, Math.round((completedModules / Math.max(totalModules / 2, 1)) * 100));
            
            document.getElementById('focus-level').textContent = focusLevel + '%';
            document.querySelector('[style*="width: 75%"]').style.width = focusLevel + '%';
            
            document.getElementById('engagement-level').textContent = engagementLevel + '%';
            document.querySelectorAll('[style*="width: 82%"]')[0].style.width = engagementLevel + '%';
            
            // Calculate weekly average
            const weeklyData = getLast7DaysActivity();
            const weeklyTotal = weeklyData.reduce((sum, day) => sum + day.minutes, 0);
            const weeklyAverage = (weeklyTotal / 7 / 60).toFixed(1);
            document.getElementById('weekly-avg').textContent = weeklyAverage + 'h';
            
            // Calculate monthly total
            let monthlyTotal = 0;
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                monthlyTotal += sessions[dateStr] || 0;
            }
            document.getElementById('monthly-total').textContent = (monthlyTotal / 60).toFixed(1) + 'h';
            
            // Calculate best day (max minutes in last 30 days)
            let bestDayMinutes = 0;
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayMinutes = sessions[dateStr] || 0;
                if (dayMinutes > bestDayMinutes) {
                    bestDayMinutes = dayMinutes;
                }
            }
            document.getElementById('best-day').textContent = (bestDayMinutes / 60).toFixed(1) + 'h';
            
            // Update consistency tracker month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthYear = monthNames[today.getMonth()] + ' ' + today.getFullYear();
            const consistencyMonthEl = document.getElementById('consistency-month');
            if (consistencyMonthEl) {
                consistencyMonthEl.textContent = monthYear;
            }
            
            // Update consistency tracker (last 30 days) with gradient colors
            const consistencyGrid = document.getElementById('consistency-grid');
            consistencyGrid.innerHTML = '';
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const minutes = sessions[dateStr] || 0;
                
                // Color intensity based on activity (5 levels)
                let bgColor = '#e5e7eb'; // no activity
                if (minutes > 0 && minutes < 30) {
                    bgColor = '#c7d2fe'; // light
                } else if (minutes >= 30 && minutes < 60) {
                    bgColor = '#818cf8'; // medium-light
                } else if (minutes >= 60 && minutes < 120) {
                    bgColor = '#6366f1'; // medium
                } else if (minutes >= 120) {
                    bgColor = '#4f46e5'; // dark
                }
                
                const div = document.createElement('div');
                div.style.cssText = `position: relative; padding-top: 100%; background: ${bgColor}; border-radius: 4px; cursor: pointer;`;
                div.title = dateStr + ': ' + (minutes > 0 ? (minutes / 60).toFixed(1) : '0') + 'h';
                consistencyGrid.appendChild(div);
            }
            
            // Update learning trends line with real data
            const activityData = getLast7DaysActivity();
            const maxMinutes = Math.max(...activityData.map(d => d.minutes), 60);
            const svgPoints = activityData.map((day, i) => {
                const x = (i / 6) * 720;
                const y = 180 - ((day.minutes / maxMinutes) * 180);
                return `${x},${y}`;
            }).join(' L');
            
            const polyline = document.getElementById('trend-polyline');
            const polygon = document.getElementById('trend-polygon');
            if (polyline && polygon) {
                polyline.setAttribute('points', svgPoints);
                const polygonPoints = svgPoints + ' 720,250 0,250';
                polygon.setAttribute('points', polygonPoints);
                
                // Update circle position
                const lastDay = activityData[activityData.length - 1];
                const lastX = (6 / 6) * 720;
                const lastY = 180 - ((lastDay.minutes / maxMinutes) * 180);
                const circles = document.querySelectorAll('#trend-polygon').length > 0 ? document.querySelectorAll('circle[cx="720"]') : [];
                circles.forEach(circle => {
                    circle.setAttribute('cy', lastY);
                });
            }
            
            // Populate course progress bars
            const progressBarsContainer = document.getElementById('course-progress-bars');
            if (progressBarsContainer && courses.length > 0) {
                progressBarsContainer.innerHTML = '';
                const maxBarHeight = 140;
                courses.slice(0, 5).forEach((course, idx) => {
                    const dailyPlan = course.dailyPlan || [];
                    const completed = dailyPlan.filter(m => m.completed).length;
                    const total = dailyPlan.length;
                    const percentage = total > 0 ? (completed / total) * 100 : 0;
                    const height = (percentage / 100) * maxBarHeight;
                    
                    const barContainer = document.createElement('div');
                    barContainer.style.cssText = 'display: flex; flex-direction: column; align-items: center; flex: 1; justify-content: flex-end;';
                    const colors = ['#6366f1', '#8b5cf6', '#d946ef', '#ec4899', '#f43f5e'];
                    barContainer.innerHTML = `
                        <div style="width: 100%; height: ${height}px; background: linear-gradient(180deg, ${colors[idx % colors.length]}, ${colors[idx % colors.length]}cc); border-radius: 4px 4px 0 0; transition: height 0.3s; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px;">
                            <span style="font-size: 10px; color: white; font-weight: 700;">${Math.round(percentage)}%</span>
                        </div>
                        <span style="margin-top: 8px; font-size: 11px; color: #9ca3af; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${(course.courseTitle || 'Course').substring(0, 12)}</span>
                    `;
                    progressBarsContainer.appendChild(barContainer);
                });
                
                // Update course info
                document.getElementById('courses-total').textContent = 'Total: ' + courses.length + ' courses';
                const activeCourses = courses.filter(c => {
                    const plan = c.dailyPlan || [];
                    return plan.filter(m => m.completed).length < plan.length;
                }).length;
                document.getElementById('courses-active').textContent = 'Active: ' + activeCourses;
            }
            
            // Update time display
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const updateTimeEl = document.getElementById('update-time');
            if (updateTimeEl) {
                updateTimeEl.textContent = timeStr;
            }
        }
        
        // Practice Labs Functions
        function updateLabsData() {
            // DSA Questions Database (updates every 24 hours based on date)
            const dsaQuestions = [
                {
                    title: 'Two Sum',
                    difficulty: 'Easy',
                    category: 'Arrays',
                    problem: 'Given an array of integers nums and an integer target, return the indices of the two numbers that add up to the target. You may assume that each input has exactly one solution, and you may not use the same element twice.',
                    input: 'nums = [2, 7, 11, 15], target = 9',
                    output: '[0, 1]'
                },
                {
                    title: 'Reverse a String',
                    difficulty: 'Easy',
                    category: 'Strings',
                    problem: 'Write a function that reverses a string. The input string is given as an array of characters s.',
                    input: 's = ["h","e","l","l","o"]',
                    output: '["o","l","l","e","h"]'
                },
                {
                    title: 'Merge Sorted Array',
                    difficulty: 'Easy',
                    category: 'Arrays',
                    problem: 'You are given two integer arrays nums1 and nums2, sorted in non-decreasing order. Merge nums2 into nums1 as one sorted array.',
                    input: 'nums1 = [1,2,3,0,0,0], m = 3, nums2 = [2,5,6], n = 3',
                    output: '[1,2,2,3,5,6]'
                },
                {
                    title: 'Valid Parentheses',
                    difficulty: 'Easy',
                    category: 'Stack',
                    problem: 'Given a string s containing just the characters "(", ")", "{", "}", "[" and "]", determine if the input string is valid.',
                    input: 's = "()[]{}"',
                    output: 'true'
                },
                {
                    title: 'Remove Duplicates',
                    difficulty: 'Easy',
                    category: 'Arrays',
                    problem: 'Given an integer array nums sorted in non-decreasing order, remove the duplicates in-place.',
                    input: 'nums = [1,1,2]',
                    output: '[1,2]'
                },
                {
                    title: 'Binary Tree Traversal',
                    difficulty: 'Medium',
                    category: 'Trees',
                    problem: 'Given the root of a binary tree, return the level order traversal of its nodes values.',
                    input: 'root = [3,9,20,null,null,15,7]',
                    output: '[[3],[9,20],[15,7]]'
                }
            ];
            
            // Get current question based on date (rotates every 24 hours)
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
            const questionIndex = dayOfYear % dsaQuestions.length;
            const todayQuestion = dsaQuestions[questionIndex];
            
            // Update question display
            document.getElementById('dsa-question-title').textContent = todayQuestion.title;
            document.getElementById('dsa-difficulty').textContent = todayQuestion.difficulty;
            document.getElementById('dsa-category').textContent = todayQuestion.category;
            document.getElementById('dsa-problem').textContent = todayQuestion.problem;
            document.getElementById('dsa-input').textContent = todayQuestion.input;
            document.getElementById('dsa-output').textContent = todayQuestion.output;
            
            // Set difficulty color
            const diffEl = document.getElementById('dsa-difficulty');
            if (todayQuestion.difficulty === 'Easy') {
                diffEl.style.background = '#d1fae5';
                diffEl.style.color = '#047857';
            } else if (todayQuestion.difficulty === 'Medium') {
                diffEl.style.background = '#fef3c7';
                diffEl.style.color = '#92400e';
            } else {
                diffEl.style.background = '#fee2e2';
                diffEl.style.color = '#991b1b';
            }
            
            // Update date display
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            const dateStr = today.toLocaleDateString('en-US', options);
            document.getElementById('dsa-question-date').textContent = `Today (${dateStr}) ‚Ä¢ Last updated at 12:00 AM`;
        }
        
        function executeLabCode() {
            const code = document.getElementById('labs-code-input').value;
            const language = document.getElementById('labs-language').value;
            const outputDiv = document.getElementById('labs-output');
            
            outputDiv.innerHTML = '';
            
            if (language === 'javascript') {
                // JavaScript execution
                const oldLog = console.log;
                let output = '';
                console.log = function(...args) {
                    output += args.join(' ') + '\n';
                };
                
                try {
                    eval(code);
                    outputDiv.innerHTML = output || '<p style="color: #858585; margin: 0;">(no output)</p>';
                    console.log = oldLog;
                } catch (err) {
                    outputDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Error: ' + err.message + '</span>';
                    console.log = oldLog;
                }
            } else if (language === 'python') {
                outputDiv.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Python execution requires backend support</span>';
            } else if (language === 'java') {
                outputDiv.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Java execution requires backend support</span>';
            } else if (language === 'c') {
                outputDiv.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è C execution requires backend support</span>';
            } else if (language === 'cpp') {
                outputDiv.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è C++ execution requires backend support</span>';
            }
        }
        
        function submitLabCode() {
            const outputDiv = document.getElementById('labs-output');
            outputDiv.innerHTML = '<span style="color: #10b981;">‚úÖ Solution submitted successfully!</span>';
        }

        // Data Structure AR/VR visualization for Practice Labs
        function openDataStructureAR() {
            const questionTitle = document.getElementById('dsa-question-title')?.textContent || 'Practice Lab';
            const category = (document.getElementById('dsa-category')?.textContent || 'Arrays').toLowerCase();
            const code = document.getElementById('labs-code-input')?.value || '';
            const dsType = category.includes('tree') ? 'tree' : category.includes('graph') ? 'graph' : category.includes('list') ? 'linked' : category.includes('stack') ? 'stack' : category.includes('queue') ? 'queue' : 'array';

            const overlay = document.createElement('div');
            overlay.id = 'ds-ar-overlay';
            overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10001; display:flex; flex-direction:column; padding:20px;';
            overlay.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0; color:#e5e7eb; font-size:20px;">üï∂Ô∏è ${questionTitle} - DS Visualizer</h2>
                    <button id="ds-ar-close" style="background:#ef4444; color:#fff; border:none; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Close</button>
                </div>
                <div style="display:grid; grid-template-columns:1.2fr 0.8fr; gap:12px; flex:1; min-height:320px;">
                    <div style="position:relative; background:#111827; border:1px solid #1f2937; border-radius:12px; overflow:hidden;">
                        <canvas id="ds-ar-canvas" style="width:100%; height:100%; display:block;"></canvas>
                    </div>
                    <div style="background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:12px; color:#cbd5e1; overflow-y:auto;">
                        <p style="margin:0 0 8px 0; font-weight:700;">${category.toUpperCase()} view</p>
                        <p style="margin:0 0 10px 0; color:#9ca3af; font-size:13px;">Quick AR/VR-style 3D view of the data structure.</p>
                        <div style="background:#1e293b; padding:10px; border-radius:8px; margin-bottom:10px;">
                            <p style="margin:0 0 6px 0; font-size:12px; color:#cbd5e1;">Code Snippet</p>
                            <pre style="margin:0; white-space:pre-wrap; word-wrap:break-word; font-size:11px; color:#10b981;">${code.substring(0,160)}${code.length>160?'...':''}</pre>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="rotateDS3DLeft()" style="flex:1; background:#0ea5e9; color:#fff; border:none; padding:8px; border-radius:8px; cursor:pointer; font-weight:600;">‚Ü∂ Rotate</button>
                            <button onclick="zoomDS3DIn()" style="flex:1; background:#22c55e; color:#0b172a; border:none; padding:8px; border-radius:8px; cursor:pointer; font-weight:700;">üîç Zoom</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            overlay.querySelector('#ds-ar-close').onclick = () => overlay.remove();
            initDS3DVisualization(dsType);
        }

        function initDS3DVisualization(dsType) {
            const canvas = document.getElementById('ds-ar-canvas');
            if (!canvas || !window.THREE) return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(70, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x0b1220, 1);

            camera.position.z = 6;

            const light = new THREE.PointLight(0xffffff, 1.2);
            light.position.set(6, 6, 6);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040, 0.8));

            addDSGeometry(scene, dsType);

            function animate() {
                requestAnimationFrame(animate);
                scene.traverse(obj => {
                    if (obj.isMesh && obj.userData.rot) {
                        obj.rotation.x += obj.userData.rot.x;
                        obj.rotation.y += obj.userData.rot.y;
                    }
                });
                renderer.render(scene, camera);
            }

            animate();
            window.dsScene = scene;
            window.dsCamera = camera;
            window.dsRenderer = renderer;
        }

        function addDSGeometry(scene, dsType) {
            const addBox = (x, y, z, color) => {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshPhongMaterial({ color }));
                mesh.position.set(x, y, z);
                mesh.userData.rot = { x: 0.003, y: 0.004 };
                scene.add(mesh);
            };

            const addSphere = (x, y, z, color) => {
                const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), new THREE.MeshPhongMaterial({ color }));
                mesh.position.set(x, y, z);
                mesh.userData.rot = { x: 0.002, y: 0.003 };
                scene.add(mesh);
            };

            if (dsType === 'tree') {
                addSphere(0, 1.5, 0, 0x0ea5e9);
                addSphere(-1, 0, 0, 0x22c55e);
                addSphere(1, 0, 0, 0x22c55e);
                addSphere(-1.5, -1.5, 0, 0xf59e0b);
                addSphere(-0.5, -1.5, 0, 0xf59e0b);
                addSphere(0.5, -1.5, 0, 0xf59e0b);
                addSphere(1.5, -1.5, 0, 0xf59e0b);
            } else if (dsType === 'linked') {
                [-2, -0.5, 1, 2.5].forEach(x => addSphere(x, 0, 0, 0x22c55e));
            } else if (dsType === 'stack') {
                [-1.2, -0.4, 0.4, 1.2].forEach((y, i) => addBox(0, y, 0, 0xec4899 + i * 7000));
            } else if (dsType === 'queue') {
                [-2.0, -0.6, 0.8, 2.2].forEach((x, i) => addBox(x, 0, 0, 0x8b5cf6 + i * 4000));
            } else {
                [-2.4, -1.2, 0, 1.2, 2.4].forEach((x, i) => addBox(x, 0, 0, 0x6366f1 + i * 3000));
            }
        }

        function rotateDS3DLeft() {
            if (window.dsCamera) window.dsCamera.position.x -= 0.5;
        }

        function zoomDS3DIn() {
            if (window.dsCamera) window.dsCamera.position.z -= 0.5;
        }
        
        function openCourseModal() {
            document.getElementById('courseModal').classList.add('active');
        }
        
        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }
        
        function selectComplexity(element) {
            document.querySelectorAll('.complexity .card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        // Minimal Generate Curriculum wiring to backend
        const generateBtn = document.getElementById('generate-curriculum-btn');
        const titleInput = document.getElementById('course-title-input');
        const linkInput = document.getElementById('course-link-input');
        const minutesInput = document.getElementById('study-minutes-input');

        // Simple client-side store for generated courses
        let courses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
        const courseGrid = document.querySelector('.course-grid'); // dashboard
        const coursesViewGrid = document.getElementById('courses-view-grid'); // courses view
        const courseCount = document.querySelector('.section-header .count');

        const gradients = [
            ['#a18cd1', '#fbc2eb'], ['#ff9a9e', '#fecfef'], ['#84fab0', '#8fd3f4'],
            ['#f6d365', '#fda085'], ['#d4fc79', '#96e6a1'], ['#a1c4fd', '#c2e9fb']
        ];

        // Mistral API helper
        async function summarizeWithMistral(text) {
            try {
                // Call Mistral API via backend to avoid CORS issues
                const response = await fetch(`${API_BASE_URL}/summarize-content/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: text })
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.summary || 'Unable to generate summary';
                }
                return 'Summary unavailable';
            } catch (err) {
                console.error('Summary error:', err);
                return 'Unable to generate summary';
            }
        }

        // Fetch and update current student information
        async function loadCurrentStudent() {
            try {
                console.log('üîç Fetching current student from:', `${API_BASE_URL}/get-current-student/`);
                const response = await fetch(`${API_BASE_URL}/get-current-student/`);
                console.log('üì° Student API response status:', response.status);
                
                if (response.ok) {
                    const student = await response.json();
                    console.log('‚úÖ Student data received:', student);
                    updateStudentUI(student);
                    
                    // Store roll number for exam and course APIs
                    if (student.roll_number) {
                        localStorage.setItem('studentRollNumber', student.roll_number);
                        console.log('üíæ Student roll number stored:', student.roll_number);
                    } else {
                        console.warn('‚ö†Ô∏è No roll_number in student data!');
                    }
                    
                    return student;
                } else {
                    console.error('‚ùå Student API returned non-OK status:', response.status);
                }
            } catch (err) {
                console.error('‚ùå Error loading student info:', err);
            }
            // Fallback to defaults if no user is logged in
            console.log('‚ö†Ô∏è No student data loaded, returning null');
            return null;
        }

        // Update all student name references in UI
        function updateStudentUI(student) {
            if (!student || !student.full_name) return;
            
            const fullName = student.full_name;
            const firstName = fullName.split(' ')[0];
            
            // Generate initials for avatar
            const initials = fullName.split(' ')
                .slice(0, 2)
                .map(n => n[0].toUpperCase())
                .join('');
            
            // Update greeting
            const greetingEl = document.querySelector('.left-column h2');
            if (greetingEl) {
                greetingEl.textContent = `Hello, ${firstName} üëã`;
            }
            
            // Update all user names in headers
            const userNames = document.querySelectorAll('.user-name');
            userNames.forEach(el => el.textContent = fullName);
            
            // Update all avatars with initials
            const avatars = document.querySelectorAll('.avatar, .avatar-large, #analytics-avatar');
            avatars.forEach(el => el.textContent = initials);
            
            // Update user stats card
            const statsCard = document.querySelector('.user-stats-card h4');
            if (statsCard) {
                statsCard.textContent = fullName;
            }
        }

        // Learning Activity Tracking
        function trackLearningSession(durationMinutes) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const sessions = JSON.parse(localStorage.getItem('learningSessions') || '{}');
            
            if (!sessions[today]) {
                sessions[today] = 0;
            }
            sessions[today] += durationMinutes;
            
            localStorage.setItem('learningSessions', JSON.stringify(sessions));
            updateActivityGraphs();
        }

        // Track individual module completion with details
        function trackModuleCompletion(courseIndex, moduleIndex) {
            const today = new Date().toISOString().split('T')[0];
            const completions = JSON.parse(localStorage.getItem('moduleCompletions') || '{}');
            
            const key = `${courseIndex}_${moduleIndex}`;
            
            if (!completions[today]) {
                completions[today] = [];
            }
            
            // Check if not already logged today
            if (!completions[today].includes(key)) {
                completions[today].push(key);
                localStorage.setItem('moduleCompletions', JSON.stringify(completions));
            }
        }

        // Track exam scores
        function trackExamScore(score) {
            // Ensure score is between 0-100
            const validScore = Math.max(0, Math.min(100, Math.round(score)));
            const examScores = JSON.parse(localStorage.getItem('examScores') || '[]');
            
            // Add the exam score with timestamp
            examScores.push({
                score: validScore,
                date: new Date().toISOString(),
                timestamp: Date.now()
            });
            
            localStorage.setItem('examScores', JSON.stringify(examScores));
            
            // Update analytics if visible
            const analyticsView = document.getElementById('analytics-view');
            if (analyticsView && !analyticsView.style.display === 'none') {
                updateAnalyticsData();
            }
            
            return validScore;
        }

        // Learning Activity - Track Learning Session
        function trackLearningSession(durationMinutes) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const sessions = JSON.parse(localStorage.getItem('learningSessions') || '{}');
            
            if (!sessions[today]) {
                sessions[today] = 0;
            }
            sessions[today] += durationMinutes;
            
            localStorage.setItem('learningSessions', JSON.stringify(sessions));
            updateActivityGraphs();
        }

        // Get last 7 days of learning activity
        function getLast7DaysActivity() {
            const sessions = JSON.parse(localStorage.getItem('learningSessions') || '{}');
            const days = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                days.push({
                    date: dateStr,
                    minutes: sessions[dateStr] || 0
                });
            }
            
            return days;
        }

        // Update activity graphs
        function updateActivityGraphs() {
            const activityData = getLast7DaysActivity();
            const totalMinutes = activityData.reduce((sum, day) => sum + day.minutes, 0);
            const totalHours = (totalMinutes / 60).toFixed(1);
            
            // Render both graphs
            renderActivityGraph('activity-chart-dashboard', activityData, totalHours);
            renderActivityGraph('activity-chart-courses', activityData, totalHours);
        }

        // Render activity graph SVG
        function renderActivityGraph(containerId, activityData, totalHours) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const maxMinutes = Math.max(...activityData.map(d => d.minutes), 30); // Min 30 for scale
            const points = activityData.map((day, i) => {
                const x = (i / 6) * 200; // Spread across 200 width
                const y = 70 - ((day.minutes / maxMinutes) * 50); // Invert Y, max height 50
                return `${x},${y}`;
            }).join(' L');
            
            // Get last point for circle highlight
            const lastDay = activityData[activityData.length - 1];
            const lastX = 200;
            const lastY = 70 - ((lastDay.minutes / maxMinutes) * 50);
            
            container.innerHTML = `
                <svg viewBox="0 0 200 80">
                    <path d="M${points}" fill="none" stroke="#6366f1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="${lastX}" cy="${lastY}" r="4" fill="#6366f1" />
                </svg>
                <div class="chart-label">${totalHours}h</div>
            `;
        }

        // Track when course player is opened
        let playerStartTime = null;
        let videoStartTime = null;
        
        function startLearningSession() {
            playerStartTime = Date.now();
            videoStartTime = Date.now();
        }

        function endLearningSession() {
            if (playerStartTime) {
                const durationMs = Date.now() - playerStartTime;
                const durationMinutes = Math.round(durationMs / 60000);
                if (durationMinutes > 0) {
                    trackLearningSession(durationMinutes);
                }
                playerStartTime = null;
                videoStartTime = null;
            }
        }

        // Track video play/pause for better time tracking
        window.trackVideoWatch = function(isPlaying) {
            if (isPlaying && !videoStartTime) {
                videoStartTime = Date.now();
            } else if (!isPlaying && videoStartTime) {
                const watchDurationMs = Date.now() - videoStartTime;
                const watchDurationMinutes = Math.round(watchDurationMs / 60000);
                if (watchDurationMinutes > 0) {
                    trackLearningSession(watchDurationMinutes);
                }
                videoStartTime = null;
            }
        };

        // Download notes as file
        window.downloadNotes = function(courseTitle) {
            const notesContent = document.getElementById('player-notes-content')?.textContent || 'No notes available';
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(notesContent));
            element.setAttribute('download', `${courseTitle.replace(/\s+/g, '_')}_notes.txt`);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        };

        // YouTube Player Ready Callback
        window.onPlayerReady = function(event) {
            console.log('YouTube player ready');
        };

        // YouTube Player State Change Callback
        window.onPlayerStateChange = function(event, courseIndex) {
            // YT.PlayerState.PLAYING = 1, PAUSED = 2, ENDED = 0
            if (event.data === 1) {
                // Video started playing
                trackVideoWatch(true);
            } else if (event.data === 2) {
                // Video paused
                trackVideoWatch(false);
            } else if (event.data === 0) {
                // Video ended
                trackVideoWatch(false);
                console.log('Video ended - showing completion modal');
                showModuleCompletionModal(courseIndex);
            }
        };

        // Show Module Completion Modal
        window.showModuleCompletionModal = function(courseIndex) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'module-completion-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1e293b;
                padding: 40px;
                border-radius: 16px;
                text-align: center;
                color: #e5e7eb;
                max-width: 400px;
                box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
            `;

            const course = window.currentCourse;
            const currentModuleIndex = window.currentModuleIndex || courseIndex;
            const nextModuleIndex = currentModuleIndex + 1;
            const hasNextModule = course.dailyPlan && nextModuleIndex < course.dailyPlan.length;

            // Mark current module as completed
            if (course.dailyPlan && course.dailyPlan[currentModuleIndex]) {
                course.dailyPlan[currentModuleIndex].completed = true;
                
                // Track module completion with detailed analytics
                trackModuleCompletion(courseIndex, currentModuleIndex);
                
                saveCourses();
            }

            modalContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">üéâ</div>
                <h2 style="margin: 0 0 20px 0; color: #10b981; font-size: 24px;">Module Completed!</h2>
                <p style="margin: 0 0 30px 0; color: #cbd5e1; font-size: 14px;">
                    Great job! You've successfully completed <strong>${course.dailyPlan[currentModuleIndex].title}</strong>.
                </p>
                <div style="display: flex; gap: 12px; flex-direction: column;">
                    ${hasNextModule ? `
                        <button id="continue-next-module-btn" style="
                            width: 100%;
                            padding: 12px 20px;
                            background: #6366f1;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#4f46e5'" onmouseout="this.style.background='#6366f1'">
                            ‚ûú Continue to Next Module
                        </button>
                    ` : ''}
                    <button id="stay-current-module-btn" style="
                        width: 100%;
                        padding: 12px 20px;
                        background: #475569;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: background 0.2s;
                    " onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                        üìö Stay on This Module
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle Continue to Next Module
            const nextBtn = document.getElementById('continue-next-module-btn');
            if (nextBtn) {
                nextBtn.onclick = function() {
                    document.body.removeChild(modal);
                    loadNextModule(nextModuleIndex);
                };
            }

            // Handle Stay on Current Module
            const stayBtn = document.getElementById('stay-current-module-btn');
            if (stayBtn) {
                stayBtn.onclick = function() {
                    document.body.removeChild(modal);
                };
            }

            // Close modal on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        };

        // Load Next Module
        window.loadNextModule = function(moduleIndex) {
            const course = window.currentCourse;
            if (!course.dailyPlan || moduleIndex >= course.dailyPlan.length) {
                alert('üéì You have completed all modules in this course! Great job!');
                return;
            }

            const nextModule = course.dailyPlan[moduleIndex];
            const moduleListItems = document.querySelectorAll('#player-lesson-list li');

            // Click the next module in the list
            if (moduleListItems[moduleIndex]) {
                moduleListItems[moduleIndex].click();
            }
        };

        // GLOBAL: Course Player Functions
        window.openCoursePlayer = function(courseIndex) {
            console.log('Opening course player for index:', courseIndex);
            console.log('Courses available:', courses);
            console.log('Course at index:', courses[courseIndex]);
            if (!courses[courseIndex]) {
                console.error('Course not found at index:', courseIndex);
                alert('Course not found');
                return;
            }
            const course = courses[courseIndex];
            const videoID = course.videoID || extractVideoId(course.courseLink) || '';
            console.log('Loading player with videoID:', videoID);
            
            // Start tracking learning session
            startLearningSession();
            
            loadCoursePlayerInline(course, courseIndex, videoID);
        };

        window.loadCoursePlayerInline = function(course, courseIndex, videoID) {
            console.log('Loading course player inline:', { course, videoID });
            let playerContainer = document.getElementById('course-player-container');
            if (!playerContainer) {
                // Create player container if it doesn't exist
                const container = document.createElement('div');
                container.id = 'course-player-container';
                container.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; display:grid; grid-template-columns:260px 1fr 320px; background:#0b1020;';
                container.innerHTML = `
                    <aside style="background:#ffffff; color:#111827; padding:20px; overflow-y:auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="margin:0;">Curriculum</h3>
                            <span id="player-progress-pill" style="background:#ede9fe; color:#6d28d9; padding:4px 10px; border-radius:999px; font-size:12px;">25% Done</span>
                        </div>
                        <ul id="player-lesson-list" style="list-style:none; margin:0; padding:0;"></ul>
                    </aside>
                    <main style="padding:20px; background:radial-gradient(circle at top,#111827,#020617); color:#e5e7eb; overflow-y:auto;">
                        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <button id="player-back-btn" style="background:#1f2937; border:none; color:#fff; padding:8px 14px; border-radius:10px; cursor:pointer;">‚Üê Courses</button>
                            <h2 id="player-title" style="margin:0; color:#e5e7eb;">Course Title</h2>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="background:#1f2937; padding:6px 12px; border-radius:999px;">04:58</span>
                            </div>
                        </header>
                        <div id="player-video" style="height:360px; background:#111827; border-radius:18px; display:flex; align-items:center; justify-content:center; margin-bottom:20px; color:white; font-size:48px;">‚ñ∂</div>
                        <section style="display:grid; grid-template-columns:2fr 1fr; gap:16px;">
                            <div style="background:#0f172a; padding:20px; border-radius:16px;">
                                <h3 id="player-module-title" style="margin:0 0 10px 0;">Module Title</h3>
                                <p id="player-module-desc" style="color:#cbd5e1; line-height:1.6;">Module description</p>
                            </div>
                            <div style="background:#0f172a; padding:20px; border-radius:16px;">
                                <h4 style="margin:0 0 10px 0;">Module Progress</h4>
                                <div style="height:8px; background:#1e293b; border-radius:999px; margin:10px 0;">
                                    <div id="player-progress-fill" style="height:100%; width:45%; background:linear-gradient(90deg,#6366f1,#8b5cf6); border-radius:999px;"></div>
                                </div>
                                <p id="player-progress-text" style="color:#cbd5e1;">0 / 0 Modules</p>
                            </div>
                        </section>
                    </main>
                    <aside style="background:#ffffff; color:#111827; padding:16px; overflow-y:auto;">
                        <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                            <button class="player-tab active" data-tab="notes" style="flex:1; min-width:70px; border:none; padding:10px; border-radius:10px; background:#eef2ff; color:#4f46e5; cursor:pointer; font-size:11px; font-weight:600;">üìù Notes</button>
                            <button class="player-tab" data-tab="lab" style="flex:1; min-width:70px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">üß™ Lab</button>
                            <button class="player-tab" data-tab="tutor" style="flex:1; min-width:70px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">ü§ñ Tutor</button>
                            <button class="player-tab" data-tab="camera" style="flex:1; min-width:70px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">üìπ Camera</button>
                        </div>
                        <div id="player-panel-content" style="background:#0f172a; color:#e5e7eb; padding:16px; border-radius:16px; display:flex; flex-direction:column; height:100%; overflow:hidden;">
                            <!-- Notes Tab -->
                            <div id="panel-notes" class="player-panel-tab active" style="display:flex; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                                <div id="player-notes-content" style="flex:1; overflow-y:auto; font-size:13px; line-height:1.6; color:#cbd5e1; margin-bottom:12px; padding-right:8px;">
                                    <p style="text-align:center; color:#9ca3af;">Select a module to see notes...</p>
                                </div>
                                <button id="download-notes-btn" onclick="downloadNotes(document.getElementById('player-title').textContent)" style="width:100%; background:#6366f1; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">üì• Download Notes</button>
                            </div>
                            
                            <!-- Lab Tab -->
                            <div id="panel-lab" class="player-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                                <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                                    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                                        <button id="lab-challenge-1" class="lab-challenge-btn active" data-challenge="1" style="flex:1; min-width:60px; padding:8px 12px; background:#6366f1; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 1</button>
                                        <button id="lab-challenge-2" class="lab-challenge-btn" data-challenge="2" style="flex:1; min-width:60px; padding:8px 12px; background:#f3f4f6; color:#111827; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 2</button>
                                        <button id="lab-challenge-3" class="lab-challenge-btn" data-challenge="3" style="flex:1; min-width:60px; padding:8px 12px; background:#f3f4f6; color:#111827; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 3</button>
                                    </div>
                                    
                                    <div id="lab-challenge-desc" style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px; font-size:12px; color:#cbd5e1; max-height:80px; overflow-y:auto;">
                                        <strong>Challenge 1: Sum Two Numbers</strong>
                                        <p style="margin:6px 0 0 0; color:#9ca3af;">Write a function that takes two numbers and returns their sum.</p>
                                    </div>
                                    
                                    <div style="flex:1; display:flex; flex-direction:column; overflow:hidden; margin-bottom:12px;">
                                        <label style="font-size:11px; color:#9ca3af; margin-bottom:6px;">Code Editor:</label>
                                        <textarea id="lab-code-editor" style="flex:1; padding:12px; background:#0f172a; color:#10b981; border:1px solid #334155; border-radius:8px; font-family:monospace; font-size:12px; resize:none;" placeholder="// Write your code here&#10;function add(a, b) {&#10;  return a + b;&#10;}"></textarea>
                                    </div>
                                    
                                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                                        <button id="lab-run-btn" style="flex:1; padding:10px 16px; background:#10b981; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">‚ñ∂ Run Code</button>
                                        <button id="lab-reset-btn" style="flex:1; padding:10px 16px; background:#f59e0b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">‚Üª Reset</button>
                                    </div>
                                    
                                    <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                                        <label style="font-size:11px; color:#9ca3af; margin-bottom:6px;">Output:</label>
                                        <div id="lab-output" style="flex:1; padding:12px; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#10b981; font-family:monospace; font-size:12px; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word;">
                                            <span style="color:#9ca3af;">Click "Run Code" to see output...</span>
                                        </div>
                                    </div>
                                    
                                    <div style="display:flex; gap:8px; margin-top:12px;">
                                        <button id="lab-immersive-btn" style="flex:1; padding:10px 12px; background:#22c55e; color:#0b172a; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700;">üï∂Ô∏è Code in AR/VR</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Tutor Tab -->
                            <div id="panel-tutor" class="player-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                                <div style="flex:1; overflow-y:auto; padding-right:8px; margin-bottom:12px;">
                                    <h4 style="margin:0 0 12px 0; color:#cbd5e1;">AI Study Buddy</h4>
                                    <div id="player-tutor-content" style="font-size:13px; color:#cbd5e1;">
                                        <div style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px;">
                                            <p style="margin:0; color:#9ca3af; font-size:12px;">Ask me anything about this module!</p>
                                        </div>
                                    </div>
                                </div>
                                <input id="tutor-input" type="text" placeholder="Ask a question..." style="width:100%; padding:10px 12px; border:1px solid #334155; border-radius:8px; background:#0f172a; color:#e5e7eb; font-size:12px; margin-bottom:8px;" />
                                <button id="tutor-ask-btn" style="width:100%; background:#f59e0b; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">Send Question</button>
                            </div>
                            
                            <!-- Camera Tab -->
                            <div id="panel-camera" class="player-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                                <h4 style="margin:0 0 12px 0; color:#cbd5e1;">Camera Analysis</h4>
                                <div id="player-camera-content" style="flex:1; overflow-y:auto; padding-right:8px; margin-bottom:12px;">
                                    <p style="color:#9ca3af; margin:0 0 12px 0; font-size:12px;">üìπ Camera monitoring helps detect distractions and engagement levels during study sessions.</p>
                                    <div id="player-camera-preview" style="width:100%; height:200px; background:#1e293b; border-radius:10px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                        <video id="player-camera-video" style="width:100%; height:100%; object-fit:cover; display:none;" autoplay muted></video>
                                        <p id="player-camera-placeholder" style="color:#9ca3af; font-size:12px;">Camera preview will appear here</p>
                                    </div>
                                    <div style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px;">
                                        <p style="margin:0; color:#cbd5e1; font-size:12px;"><strong>Status:</strong> <span id="player-camera-status" style="color:#ef4444;">Permission Denied</span></p>
                                        <p style="margin:8px 0 0 0; color:#9ca3af; font-size:11px;">Camera access is required for proctoring features.</p>
                                    </div>
                                </div>
                                <button id="enable-camera-btn" style="width:100%; background:#3b82f6; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">üîí Enable Camera</button>
                                <div id="player-motivator" style="margin-top:12px; background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:12px;">
                                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; color:#cbd5e1; font-weight:600; font-size:12px;">
                                        <span>ü§ñ</span> <span>AI Motivator</span>
                                    </div>
                                    <p id="player-motivator-text" style="margin:0; color:#9ca3af; font-size:12px;">Let‚Äôs stay focused. Small steps add up‚Äîtry summarizing the last minute.</p>
                                </div>
                                <div id="player-immersive-card" style="margin-top:12px; background:#0f172a; border:1px dashed #334155; border-radius:10px; padding:12px;">
                                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; color:#cbd5e1; font-weight:600; font-size:12px;">
                                        <span>üï∂Ô∏è</span> <span>Immersive Mode (beta)</span>
                                    </div>
                                    <p style="margin:0 0 10px 0; color:#9ca3af; font-size:12px;">Try an AR/VR flavored study view. We‚Äôll check if your browser supports WebXR and show a preview.</p>
                                    <button id="open-immersive-btn" style="width:100%; background:#22c55e; border:none; color:#0b172a; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700;">Launch Immersive Preview</button>
                                </div>
                            </div>
                        </div>
                    </aside>
                `;
                document.body.appendChild(container);
                playerContainer = container;
            }

            // Update player content
            const title = course.courseTitle || 'Course Title';
            const desc = course.courseDescription || 'Course description';
            document.getElementById('player-title').textContent = title;
            document.getElementById('player-module-title').textContent = title;
            document.getElementById('player-module-desc').textContent = desc;

            // Load curriculum
            const lessonList = document.getElementById('player-lesson-list');
            if (course.dailyPlan && lessonList) {
                lessonList.innerHTML = '';
                const totalModules = course.dailyPlan.length;
                const completedModules = course.dailyPlan.filter(m => m.completed).length;
                const currentModuleIndex = course.dailyPlan.findIndex(m => !m.completed);
                
                document.getElementById('player-progress-pill').textContent = `${Math.round((completedModules / totalModules) * 100)}% Done`;
                document.getElementById('player-progress-fill').style.width = `${Math.round((completedModules / totalModules) * 100)}%`;
                document.getElementById('player-progress-text').textContent = `${completedModules} / ${totalModules} Modules ‚Ä¢ ${Math.round((completedModules / totalModules) * 100)}%`;

                course.dailyPlan.forEach((module, idx) => {
                    const li = document.createElement('li');
                    const duration = module.duration ? `${module.duration.toFixed(1)}h` : '45 min';
                    li.style.cssText = 'padding:12px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; font-size:14px; cursor:pointer;';
                    
                    if (module.completed) {
                        li.style.color = '#16a34a';
                        li.className = 'done';
                    } else if (idx === currentModuleIndex) {
                        li.style.cssText += 'background:#eef2ff; color:#4f46e5;';
                        li.className = 'active';
                    } else if (idx > currentModuleIndex) {
                        li.style.color = '#9ca3af';
                        li.className = 'locked';
                    }
                    
                    li.innerHTML = `${module.title} <span>${duration}</span>`;
                    li.onclick = async () => {
                        // Update module view
                        document.getElementById('player-module-title').textContent = module.title;
                        document.getElementById('player-module-desc').textContent = module.description || 'No description available';
                        
                        // Generate and show summary
                        const notesContent = document.getElementById('player-notes-content');
                        notesContent.innerHTML = '<p style="color:#9ca3af; text-align:center;">‚è≥ Generating summary...</p>';
                        
                        const summaryText = `Module: ${module.title}\nDuration: ${duration}\n\nKey Topics:\n- ${module.title}\n\nLearning Objectives: ${module.description || 'To master the concepts covered in this module'}`;
                        const summary = await summarizeWithMistral(summaryText);
                        
                        notesContent.innerHTML = `<strong style="font-size:14px;">${module.title}</strong><p style="margin:8px 0 4px 0; color:#9ca3af; font-size:11px;">Duration: ${duration}</p><hr style="border:none; border-top:1px solid #334155; margin:12px 0;"><div style="white-space:pre-wrap;">${summary}</div>`;
                    };
                    lessonList.appendChild(li);
                });
            }

            // Embed video with YouTube IFrame API
            const videoContainer = document.getElementById('player-video');
            if (videoID && videoContainer) {
                // Create unique player ID
                const playerId = `player-${videoID}-${courseIndex}`;
                videoContainer.id = playerId;
                videoContainer.innerHTML = '';
                
                // Load YouTube IFrame API if not already loaded
                if (!window.YT) {
                    window.YT = undefined;
                    const tag = document.createElement('script');
                    tag.src = 'https://www.youtube.com/iframe_api';
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                }
                
                // Wait for YT API to be ready
                const checkYT = setInterval(() => {
                    if (window.YT && window.YT.Player) {
                        clearInterval(checkYT);
                        
                        // Create player
                        window.currentYouTubePlayer = new YT.Player(playerId, {
                            height: '100%',
                            width: '100%',
                            videoId: videoID,
                            playerVars: {
                                'controls': 1,
                                'modestbranding': 1,
                                'rel': 0,
                                'fs': 1
                            },
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': (event) => onPlayerStateChange(event, courseIndex)
                            }
                        });
                    }
                }, 100);
                
                // Set timeout to fallback to iframe if API doesn't load
                setTimeout(() => {
                    if (!window.currentYouTubePlayer) {
                        const embedUrl = `https://www.youtube.com/embed/${videoID}?rel=0&modestbranding=1&controls=1`;
                        const youtubeLink = `https://www.youtube.com/watch?v=${videoID}`;
                        videoContainer.innerHTML = `<iframe style="width:100%;height:100%;border:none;border-radius:18px;" 
                            src="${embedUrl}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin">
                        </iframe>`;
                    }
                }, 3000);
                
            } else if (!videoID && videoContainer) {
                videoContainer.innerHTML = '<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#999; font-size:18px;">No video available</div>';
            }
            
            // Store current module info for completion detection
            window.currentModuleIndex = courseIndex;
            window.currentCourse = course;

            // Back button
            const backBtn = document.getElementById('player-back-btn');
            if (backBtn) {
                backBtn.onclick = () => {
                    // End learning session tracking
                    endLearningSession();
                    if (window.currentCameraStream) {
                        window.currentCameraStream.getTracks().forEach(t => t.stop());
                        window.currentCameraStream = null;
                    }
                    
                    playerContainer.style.display = 'none';
                };
            }

            // AI Motivator rotation
            const motivatorTextEl = document.getElementById('player-motivator-text');
            const motivatorPrompts = [
                'Stay with it‚Äînote one key takeaway from this segment.',
                'Do a 30-second stretch, then recap the last topic.',
                'Mute phone distractions for 10 minutes and push through.',
                'Teach it aloud: explain this concept in one sentence.',
                'Hydrate check: sip water, then continue focused.'
            ];
            if (motivatorTextEl) {
                const setPrompt = () => {
                    const pick = motivatorPrompts[Math.floor(Math.random() * motivatorPrompts.length)];
                    motivatorTextEl.textContent = pick;
                };
                // Clear prior interval if any
                if (window.courseMotivatorInterval) {
                    clearInterval(window.courseMotivatorInterval);
                }
                setPrompt();
                window.courseMotivatorInterval = setInterval(setPrompt, 45000);
            }

            // Tab switching functionality - with delayed initialization
            setTimeout(() => {
                const tabButtons = document.querySelectorAll('.player-tab');
                const tabPanels = document.querySelectorAll('.player-panel-tab');
                
                if (tabButtons.length === 0) {
                    console.error('Tab buttons not found');
                    return;
                }
                
                tabButtons.forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const tabName = this.getAttribute('data-tab');
                        console.log('Switching to tab:', tabName);
                        
                        // Update button styles
                        tabButtons.forEach(b => {
                            b.style.background = '#f3f4f6';
                            b.style.color = '#111827';
                        });
                        this.style.background = '#eef2ff';
                        this.style.color = '#4f46e5';
                        
                        // Update panel visibility
                        tabPanels.forEach(panel => {
                            panel.style.display = 'none';
                        });
                        
                        const activePanel = document.getElementById(`panel-${tabName}`);
                        if (activePanel) {
                            activePanel.style.display = 'flex';
                            console.log(`Showed panel: panel-${tabName}`);
                        } else {
                            console.error(`Panel not found: panel-${tabName}`);
                        }
                    };
                });
                
                // AI Tutor question handler
                const tutorBtn = document.getElementById('tutor-ask-btn');
                const tutorInput = document.getElementById('tutor-input');
                
                if (tutorBtn && tutorInput) {
                    // Allow Enter key to send question
                    tutorInput.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            tutorBtn.click();
                        }
                    };
                    
                    tutorBtn.onclick = async function(e) {
                        e.preventDefault();
                        const question = tutorInput.value.trim();
                        if (!question) {
                            alert('Please ask a question');
                            return;
                        }
                        
                        const tutorContent = document.getElementById('player-tutor-content');
                        const originalText = tutorBtn.textContent;
                        tutorBtn.textContent = '‚è≥ Thinking...';
                        tutorBtn.disabled = true;
                        
                        try {
                            console.log('Sending tutor question:', question);
                            const response = await fetch(`${API_BASE_URL}/get-hint/`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ question: question, module: document.getElementById('player-module-title').textContent })
                            });
                            
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            
                            const data = await response.json();
                            const answer = data.hint || data.answer || 'Great question! That\'s an important concept to understand.';
                            
                            const messageDiv = document.createElement('div');
                            messageDiv.style.cssText = 'background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px;';
                            messageDiv.innerHTML = `
                                <p style="margin:0; color:#f59e0b; font-size:12px;"><strong>You:</strong> ${question}</p>
                                <p style="margin:8px 0 0 0; color:#10b981; font-size:12px;"><strong>Tutor:</strong> ${answer}</p>
                            `;
                            tutorContent.appendChild(messageDiv);
                            tutorInput.value = '';
                            tutorContent.parentElement.scrollTop = tutorContent.parentElement.scrollHeight;
                        } catch (err) {
                            console.error('Tutor error:', err);
                            alert('Error: ' + err.message);
                        } finally {
                            tutorBtn.textContent = originalText;
                            tutorBtn.disabled = false;
                        }
                    };
                } else {
                    console.error('Tutor elements not found - btn:', !!tutorBtn, 'input:', !!tutorInput);
                }
                
                // Camera enable handler
                const cameraBtn = document.getElementById('enable-camera-btn');
                if (cameraBtn) {
                    cameraBtn.onclick = async function(e) {
                        e.preventDefault();
                        try {
                            console.log('Requesting camera access...');
                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                video: { 
                                    width: { ideal: 320 },
                                    height: { ideal: 240 }
                                },
                                audio: false
                            });
                            // Keep stream for cleanup
                            window.currentCameraStream = stream;

                            const videoEl = document.getElementById('player-camera-video');
                            const placeholder = document.getElementById('player-camera-placeholder');
                            const statusEl = document.getElementById('player-camera-status');
                            if (videoEl) {
                                videoEl.srcObject = stream;
                                await videoEl.play();
                                videoEl.style.display = 'block';
                            }
                            if (placeholder) placeholder.style.display = 'none';
                            if (statusEl) {
                                statusEl.textContent = '‚úì Camera Active';
                                statusEl.style.color = '#10b981';
                            }

                            const cameraContent = document.getElementById('player-camera-content');
                            if (cameraContent && !document.getElementById('player-camera-analytics')) {
                                const analyticsCard = document.createElement('div');
                                analyticsCard.id = 'player-camera-analytics';
                                analyticsCard.style.cssText = 'margin-top:12px; padding:12px; background:#0f172a; border-radius:8px; font-size:11px; color:#9ca3af;';
                                analyticsCard.innerHTML = `
                                    <p style="margin:0;">üìä Analytics Active:</p>
                                    <p style="margin:4px 0 0 0;">‚Ä¢ Attention level monitoring</p>
                                    <p style="margin:4px 0 0 0;">‚Ä¢ Distraction detection</p>
                                    <p style="margin:4px 0 0 0;">‚Ä¢ Study duration tracking</p>
                                `;
                                cameraContent.appendChild(analyticsCard);
                            }

                            cameraBtn.textContent = '‚úì Camera Enabled';
                            cameraBtn.disabled = true;
                            cameraBtn.style.background = '#10b981';
                            cameraBtn.style.cursor = 'default';
                        } catch (err) {
                            console.error('Camera error:', err);
                            alert('Camera access denied. Please allow camera permissions to enable proctoring.');
                        }
                    };
                } else {
                    console.error('Camera button not found');
                }

                // Immersive (AR/VR flavor) preview
                const immersiveBtn = document.getElementById('open-immersive-btn');
                if (immersiveBtn) {
                    immersiveBtn.onclick = () => {
                        ensureImmersiveOverlay();
                        showImmersiveOverlay();
                    };
                }

                // Lab immersive button
                const labImmersiveBtn = document.getElementById('lab-immersive-btn');
                if (labImmersiveBtn) {
                    labImmersiveBtn.onclick = () => {
                        const code = document.getElementById('lab-code-editor').value;
                        const output = document.getElementById('lab-output').innerText;
                        showLabImmersiveOverlay(code, output);
                    };
                }
                
                // Lab Compiler Setup
                const labChallenges = {
                    1: {
                        title: 'Sum Two Numbers',
                        description: 'Write a function that takes two numbers and returns their sum.',
                        template: 'function add(a, b) {\n  return a + b;\n}\n\n// Test\nconsole.log(add(5, 3)); // Expected: 8',
                        testCode: 'function add(a, b) {\n  return a + b;\n}\nconsole.log(add(5, 3)); // Expected: 8'
                    },
                    2: {
                        title: 'Check if Even or Odd',
                        description: 'Write a function that determines if a number is even or odd.',
                        template: 'function isEven(num) {\n  return num % 2 === 0;\n}\n\n// Test\nconsole.log(isEven(4));  // Expected: true\nconsole.log(isEven(7));  // Expected: false',
                        testCode: 'function isEven(num) {\n  return num % 2 === 0;\n}\nconsole.log(isEven(4));  // Expected: true\nconsole.log(isEven(7));  // Expected: false'
                    },
                    3: {
                        title: 'Calculate Factorial',
                        description: 'Write a function that calculates the factorial of a number.',
                        template: 'function factorial(n) {\n  if (n <= 1) return 1;\n  return n * factorial(n - 1);\n}\n\n// Test\nconsole.log(factorial(5)); // Expected: 120',
                        testCode: 'function factorial(n) {\n  if (n <= 1) return 1;\n  return n * factorial(n - 1);\n}\nconsole.log(factorial(5)); // Expected: 120'
                    }
                };
                
                // Challenge button handlers
                const challengeBtns = document.querySelectorAll('.lab-challenge-btn');
                challengeBtns.forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        const challengeNum = this.getAttribute('data-challenge');
                        const challenge = labChallenges[challengeNum];
                        
                        // Update active button
                        challengeBtns.forEach(b => {
                            b.style.background = '#f3f4f6';
                            b.style.color = '#111827';
                        });
                        this.style.background = '#6366f1';
                        this.style.color = '#fff';
                        
                        // Update description
                        const descEl = document.getElementById('lab-challenge-desc');
                        if (descEl) {
                            descEl.innerHTML = `<strong>Challenge ${challengeNum}: ${challenge.title}</strong><p style="margin:6px 0 0 0; color:#9ca3af;">${challenge.description}</p>`;
                        }
                        
                        // Update code editor
                        const editor = document.getElementById('lab-code-editor');
                        if (editor) {
                            editor.value = challenge.template;
                        }
                        
                        // Clear output
                        const output = document.getElementById('lab-output');
                        if (output) {
                            output.innerHTML = '<span style="color:#9ca3af;">Click "Run Code" to see output...</span>';
                        }
                    };
                });
                
                // Run Code button
                const runBtn = document.getElementById('lab-run-btn');
                if (runBtn) {
                    runBtn.onclick = function(e) {
                        e.preventDefault();
                        const editor = document.getElementById('lab-code-editor');
                        const output = document.getElementById('lab-output');
                        
                        if (!editor || !output) return;
                        
                        const code = editor.value;
                        output.innerHTML = '<span style="color:#f59e0b;">‚è≥ Running code...</span>';
                        runBtn.textContent = '‚è≥ Running...';
                        runBtn.disabled = true;
                        
                        try {
                            // Send code to backend for execution
                            fetch(`${API_BASE_URL}/execute-code/`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ code: code })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.error) {
                                    output.innerHTML = `<span style="color:#ef4444;">‚ùå Error:\\n${data.error}</span>`;
                                } else {
                                    output.innerHTML = `<span style="color:#10b981;">‚úì Output:\\n${data.output || '(No output)'}</span>`;
                                }
                            })
                            .catch(err => {
                                // Fallback to client-side execution
                                try {
                                    let consoleOutput = '';
                                    const originalLog = console.log;
                                    console.log = function(...args) {
                                        consoleOutput += args.join(' ') + '\\n';
                                    };
                                    
                                    eval(code);
                                    
                                    console.log = originalLog;
                                    output.innerHTML = `<span style="color:#10b981;">‚úì Output:\\n${consoleOutput || '(No output)'}</span>`;
                                } catch (evalErr) {
                                    output.innerHTML = `<span style="color:#ef4444;">‚ùå Error:\\n${evalErr.message}</span>`;
                                }
                            });
                        } catch (err) {
                            output.innerHTML = `<span style="color:#ef4444;">‚ùå Error:\\n${err.message}</span>`;
                        } finally {
                            runBtn.textContent = '‚ñ∂ Run Code';
                            runBtn.disabled = false;
                        }
                    };
                }
                
                // Reset button
                const resetBtn = document.getElementById('lab-reset-btn');
                if (resetBtn) {
                    resetBtn.onclick = function(e) {
                        e.preventDefault();
                        const editor = document.getElementById('lab-code-editor');
                        const output = document.getElementById('lab-output');
                        
                        if (editor) {
                            const firstChallenge = labChallenges[1];
                            editor.value = firstChallenge.template;
                        }
                        
                        if (output) {
                            output.innerHTML = '<span style="color:#9ca3af;">Click "Run Code" to see output...</span>';
                        }
                    };
                }
                
            }, 100); // Small delay to ensure DOM is ready

            // Show player
            playerContainer.style.display = 'grid';
        };

        function saveCourses() {
            localStorage.setItem('generatedCourses', JSON.stringify(courses));
        }

        function extractVideoId(url) {
            if (!url) return null;
            try {
                const u = new URL(url);
                if (u.hostname === 'youtu.be') {
                    // For youtu.be/VIDEO_ID?params - get just the video ID without query params
                    return u.pathname.slice(1).split('?')[0];
                }
                if (u.hostname.includes('youtube.com')) {
                    return u.searchParams.get('v');
                }
            } catch (e) {
                // Try regex as fallback for malformed URLs
                const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([a-zA-Z0-9_-]{11})/);
                return match ? match[1] : null;
            }
            return null;
        }

        function renderCourses() {
            // Reload courses from storage to ensure fresh data
            courses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
            
            if (courseCount) {
                courseCount.textContent = `(${courses.length})`;
            }

            const renderInto = (container, cardClass) => {
                if (!container) return;
                if (courses.length === 0) {
                    container.innerHTML = cardClass === 'course-card'
                        ? `
                            <div class="course-card" style="justify-content:center; align-items:center; text-align:center; padding:32px;">
                                <div class="card-body">
                                    <span class="level beginner">No courses yet</span>
                                    <h4>Add a course to get started</h4>
                                    <p class="subtitle">Use ‚ÄúAdd Course‚Äù or ‚ÄúGenerate Course Curriculum‚Äù to build your plan.</p>
                                </div>
                            </div>
                        `
                        : `
                            <div class="course-card" style="justify-content:center; align-items:center; text-align:center; padding:32px;">
                                <div class="card-body">
                                    <span class="level beginner">No courses yet</span>
                                    <h4>Add a course to get started</h4>
                                    <p class="subtitle">Use "Add Course" or "Generate Course Curriculum" to build your plan.</p>
                                </div>
                            </div>
                        `;
                    return;
                }

                container.innerHTML = '';
                courses.forEach((course, idx) => {
                    const videoID = course.videoID || extractVideoId(course.courseLink) || '';
                    const gradient = gradients[idx % gradients.length];
                    const thumbMax = videoID ? `https://img.youtube.com/vi/${videoID}/maxresdefault.jpg` : '';
                    const thumbHq = videoID ? `https://img.youtube.com/vi/${videoID}/hqdefault.jpg` : '';
                    const gradientPlaceholder = `https://placehold.co/600x360/${gradient[0].substring(1)}/${gradient[1].substring(1)}?text=${encodeURIComponent((course.courseTitle||'Course').split(' ').slice(0,3).join(' '))}&font=manrope`;
                    const onErrorScript = thumbHq ? `this.onerror=null; this.src='${thumbHq}'; this.onerror=function(){this.onerror=null; this.src='${gradientPlaceholder}';}` : '';

                    const card = document.createElement('div');
                    card.className = cardClass;
                    const courseIndex = courses.indexOf(course);
                    card.innerHTML = cardClass === 'course-card'
                        ? `
                            ${videoID ? `<img src="${thumbMax}" alt="${course.courseTitle}" onerror="${onErrorScript}">` : ''}
                            <div class="card-body">
                                <div class="level beginner">${course.progress ?? 0}%</div>
                                <h4>${course.courseTitle || 'Untitled Course'}</h4>
                                <p>${course.courseDescription || 'Curriculum generated.'}</p>
                                <div class="meta" style="display:flex; justify-content:space-between; align-items:center;">
                                    <span><i class="far fa-clock"></i> ${course.dailyPlan?.length || 0} modules</span>
                                    <button onclick="openCoursePlayer(${courseIndex})" style="background:#6366f1; color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">Continue Learning</button>
                                </div>
                            </div>
                        `
                        : `
                            <div class="bg-white rounded-[2rem] overflow-hidden card-shadow flex flex-col h-full">
                                ${videoID ? `<img src="${thumbMax}" alt="${course.courseTitle}" onerror="${onErrorScript}" class="w-full h-48 object-cover">` : ''}
                                <div class="p-6 flex flex-col gap-3 flex-1">
                                    <div class="text-xs font-bold text-indigo-500">${course.progress ?? 0}% complete</div>
                                    <h4 class="font-bold text-slate-800 text-lg">${course.courseTitle || 'Untitled Course'}</h4>
                                    <p class="text-sm text-slate-500">${course.courseDescription || 'Curriculum generated.'}</p>
                                    <div class="text-xs text-slate-400 flex items-center gap-2"><i class="far fa-clock"></i> ${course.dailyPlan?.length || 0} modules</div>
                                    <button onclick="openCoursePlayer(${courseIndex})" style="background:#6366f1; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; margin-top:auto;">Continue Learning ‚Üí</button>
                                </div>
                            </div>
                        `;
                    container.appendChild(card);
                });
            };

            renderInto(courseGrid, 'course-card');
            renderInto(coursesViewGrid, 'course-view-card');
            
            // Update Today's Focus section with first course
            updateTodaysFocus();
        }
        
        // Fetch enrolled courses from backend and merge with local courses
        async function loadEnrolledCourses() {
            try {
                // Use Django backend API for enrolled courses (Django runs on port 786)
                const DJANGO_API = 'http://127.0.0.1:786';
                
                console.log('üîç Loading enrolled courses...');
                
                // First, try to get student info to get roll number
                let rollNumber = localStorage.getItem('studentRollNumber');
                console.log('üìã Roll number from localStorage:', rollNumber);
                
                if (!rollNumber) {
                    console.log('‚ö†Ô∏è No roll number in localStorage, fetching student info...');
                    try {
                        const studentResponse = await fetch(`${API_BASE_URL}/get-current-student/`);
                        if (studentResponse.ok) {
                            const student = await studentResponse.json();
                            rollNumber = student.roll_number;
                            // Store for future use (including exams)
                            if (rollNumber) {
                                localStorage.setItem('studentRollNumber', rollNumber);
                                console.log('‚úÖ Stored student roll number:', rollNumber);
                            } else {
                                console.warn('‚ö†Ô∏è Student info received but no roll_number:', student);
                            }
                        }
                    } catch (e) {
                        console.log('‚ùå Could not get student info:', e);
                    }
                }
                
                let response;
                if (rollNumber) {
                    // Use roll number based endpoint (works without session auth)
                    const url = `${DJANGO_API}/api/student/courses/${rollNumber}/`;
                    console.log('üì° Fetching courses from:', url);
                    response = await fetch(url);
                } else {
                    console.warn('‚ö†Ô∏è No roll number available, using session-based auth');
                    // Fallback to session-based auth
                    response = await fetch(`${DJANGO_API}/api/student/courses/`, {
                        credentials: 'include'
                    });
                }
                
                console.log('üì° Courses API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    const backendCourses = data.courses || [];
                    
                    console.log('‚úÖ Backend courses loaded:', backendCourses.length, 'courses');
                    console.log('üìö Course details:', backendCourses);
                    
                    // Get local generated courses
                    const localCourses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
                    console.log('üíæ Local courses:', localCourses.length, 'courses');
                    
                    // Mark backend courses with a flag
                    const markedBackendCourses = backendCourses.map(c => ({...c, isBackendCourse: true}));
                    
                    // Combine: backend courses first, then local courses
                    courses = [...markedBackendCourses, ...localCourses];
                    console.log('üìä Total courses after merge:', courses.length);
                    
                    if (courseCount) {
                        courseCount.textContent = `(${courses.length})`;
                    }
                    
                    renderCoursesWithBackend();
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to load enrolled courses. Status:', response.status, 'Error:', errorText);
                    renderCourses();
                }
            } catch (err) {
                console.error('‚ùå Error loading enrolled courses:', err);
                // Fallback to local courses only
                renderCourses();
            }
        }
        
        // Render courses including backend courses
        function renderCoursesWithBackend() {
            const renderInto = (container, cardClass) => {
                if (!container) return;
                if (courses.length === 0) {
                    container.innerHTML = `
                        <div class="course-card" style="justify-content:center; align-items:center; text-align:center; padding:32px;">
                            <div class="card-body">
                                <span class="level beginner">No courses yet</span>
                                <h4>Add a course to get started</h4>
                                <p class="subtitle">Use "Add Course" or "Generate Course Curriculum" to build your plan.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                courses.forEach((course, idx) => {
                    const gradient = gradients[idx % gradients.length];
                    const card = document.createElement('div');
                    card.className = cardClass;
                    const courseIndex = idx;
                    
                    // Check if it's a backend course
                    if (course.isBackendCourse || (course.id && !course.dailyPlan)) {
                        // Faculty-created course from backend - render like AI courses with YouTube thumbnail
                        const levelColors = {
                            'beginner': '#10b981',
                            'intermediate': '#6366f1',
                            'advanced': '#ef4444'
                        };
                        const levelColor = levelColors[course.level] || '#6366f1';
                        
                        // Extract video ID from backend course video_url
                        const videoID = course.video_url ? extractVideoId(course.video_url) : null;
                        const thumbMax = videoID ? `https://img.youtube.com/vi/${videoID}/maxresdefault.jpg` : '';
                        const thumbHq = videoID ? `https://img.youtube.com/vi/${videoID}/hqdefault.jpg` : '';
                        const gradientPlaceholder = `linear-gradient(135deg, ${gradient[0]}, ${gradient[1]})`;
                        const onErrorScript = thumbHq ? `this.onerror=null; this.src='${thumbHq}'; this.onerror=function(){this.onerror=null; this.parentElement.innerHTML='<div style=\\'height:100%; display:flex; align-items:center; justify-content:center; font-size:48px; background:${gradientPlaceholder}\\'>üìö</div>';}` : '';
                        
                        card.innerHTML = cardClass === 'course-card'
                            ? `
                                ${videoID 
                                    ? `<img src="${thumbMax}" alt="${course.title}" style="height:140px; width:100%; object-fit:cover;" onerror="${onErrorScript}">`
                                    : `<div style="height:140px; background:linear-gradient(135deg, ${gradient[0]}, ${gradient[1]}); display:flex; align-items:center; justify-content:center; font-size:48px;">üìö</div>`
                                }
                                <div class="card-body">
                                    <div class="level" style="background:${levelColor}20; color:${levelColor};">${(course.level || 'beginner').toUpperCase()}</div>
                                    <h4>${course.title || 'Untitled Course'}</h4>
                                    <p>${course.description || 'Course by ' + (course.faculty_name || 'Faculty')}</p>
                                    <div class="meta" style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                                        <span><i class="far fa-user"></i> ${course.faculty_name || 'Faculty'}</span>
                                    </div>
                                    <div style="margin-top:8px;">
                                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                                            <span>Progress</span><span>${course.progress || 0}%</span>
                                        </div>
                                        <div style="height:4px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                                            <div style="height:100%; width:${course.progress || 0}%; background:${levelColor}; border-radius:4px;"></div>
                                        </div>
                                    </div>
                                    <button onclick="openBackendCoursePlayer(${courseIndex})" style="width:100%; background:#6366f1; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; margin-top:12px;">Continue Learning ‚Üí</button>
                                </div>
                            `
                            : `
                                <div class="bg-white rounded-[2rem] overflow-hidden card-shadow flex flex-col h-full">
                                    ${videoID 
                                        ? `<img src="${thumbMax}" alt="${course.title}" class="w-full h-48 object-cover" onerror="${onErrorScript}">`
                                        : `<div style="height:180px; background:linear-gradient(135deg, ${gradient[0]}, ${gradient[1]}); display:flex; align-items:center; justify-content:center; font-size:48px;">üìö</div>`
                                    }
                                    <div class="p-6 flex flex-col gap-3 flex-1">
                                        <div class="text-xs font-bold" style="color:${levelColor};">${course.progress || 0}% complete</div>
                                        <h4 class="font-bold text-slate-800 text-lg">${course.title || 'Untitled Course'}</h4>
                                        <p class="text-sm text-slate-500">${course.description || ''}</p>
                                        <div class="text-xs text-slate-400"><i class="far fa-user"></i> ${course.faculty_name || 'Faculty'}</div>
                                        <div style="margin-top:8px;">
                                            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                                                <span>Progress</span><span>${course.progress || 0}%</span>
                                            </div>
                                            <div style="height:6px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                                                <div style="height:100%; width:${course.progress || 0}%; background:${levelColor}; border-radius:4px;"></div>
                                            </div>
                                        </div>
                                        <button onclick="openBackendCoursePlayer(${courseIndex})" style="background:#6366f1; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; margin-top:auto;">Continue Learning ‚Üí</button>
                                    </div>
                                </div>
                            `;
                    } else {
                        // AI-generated course
                        const videoID = course.videoID || extractVideoId(course.courseLink) || '';
                        const thumbMax = videoID ? `https://img.youtube.com/vi/${videoID}/maxresdefault.jpg` : '';
                        const thumbHq = videoID ? `https://img.youtube.com/vi/${videoID}/hqdefault.jpg` : '';
                        const gradientPlaceholder = `https://placehold.co/600x360/${gradient[0].substring(1)}/${gradient[1].substring(1)}?text=${encodeURIComponent((course.courseTitle||'Course').split(' ').slice(0,3).join(' '))}&font=manrope`;
                        const onErrorScript = thumbHq ? `this.onerror=null; this.src='${thumbHq}'; this.onerror=function(){this.onerror=null; this.src='${gradientPlaceholder}';}` : '';
                        const courseIndex = courses.indexOf(course);
                        
                        card.innerHTML = cardClass === 'course-card'
                            ? `
                                ${videoID ? `<img src="${thumbMax}" alt="${course.courseTitle}" onerror="${onErrorScript}">` : ''}
                                <div class="card-body">
                                    <div class="level beginner">${course.progress ?? 0}%</div>
                                    <h4>${course.courseTitle || 'Untitled Course'}</h4>
                                    <p>${course.courseDescription || 'Curriculum generated.'}</p>
                                    <div class="meta" style="display:flex; justify-content:space-between; align-items:center;">
                                        <span><i class="far fa-clock"></i> ${course.dailyPlan?.length || 0} modules</span>
                                        <button onclick="openCoursePlayer(${courseIndex})" style="background:#6366f1; color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">Continue Learning</button>
                                    </div>
                                </div>
                            `
                            : `
                                <div class="bg-white rounded-[2rem] overflow-hidden card-shadow flex flex-col h-full">
                                    ${videoID ? `<img src="${thumbMax}" alt="${course.courseTitle}" onerror="${onErrorScript}" class="w-full h-48 object-cover">` : ''}
                                    <div class="p-6 flex flex-col gap-3 flex-1">
                                        <div class="text-xs font-bold text-indigo-500">${course.progress ?? 0}% complete</div>
                                        <h4 class="font-bold text-slate-800 text-lg">${course.courseTitle || 'Untitled Course'}</h4>
                                        <p class="text-sm text-slate-500">${course.courseDescription || 'Curriculum generated.'}</p>
                                        <div class="text-xs text-slate-400 flex items-center gap-2"><i class="far fa-clock"></i> ${course.dailyPlan?.length || 0} modules</div>
                                        <button onclick="openCoursePlayer(${courseIndex})" style="background:#6366f1; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; margin-top:auto;">Continue Learning ‚Üí</button>
                                    </div>
                                </div>
                            `;
                    }
                    container.appendChild(card);
                });
            };

            renderInto(courseGrid, 'course-card');
            renderInto(coursesViewGrid, 'course-view-card');
            updateTodaysFocus();
        }
        
        // View backend course details
        // Open backend (faculty-created) course in the course player
        function openBackendCoursePlayer(courseIndex) {
            console.log('Opening backend course player for index:', courseIndex);
            const course = courses[courseIndex];
            if (!course) {
                console.error('Course not found at index:', courseIndex);
                alert('Course not found');
                return;
            }
            
            console.log('Backend course:', course);
            
            // Extract video ID from course video_url
            const videoID = course.video_url ? extractVideoId(course.video_url) : null;
            
            if (!videoID) {
                alert('This course does not have a video link yet.');
                return;
            }
            
            // Start tracking learning session
            startLearningSession();
            
            // Load the course player with backend course data
            loadBackendCoursePlayer(course, courseIndex, videoID);
        }
        
        // Load backend course into player - Full featured like AI-generated courses
        function loadBackendCoursePlayer(course, courseIndex, videoID) {
            // Remove existing player if any
            const existingPlayer = document.getElementById('course-player-container');
            if (existingPlayer) existingPlayer.remove();
            
            // Generate modules based on study hours (if available) or create default modules
            const studyHours = parseFloat(course.study_hours) || 4;
            const modulesCount = course.modules_count || Math.max(1, Math.ceil(studyHours * 2)); // ~30min per module
            const modules = course.modules || generateModulesForCourse(course, modulesCount);
            
            // Create player container
            const container = document.createElement('div');
            container.id = 'course-player-container';
            container.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; display:grid; grid-template-columns:260px 1fr 320px; background:#0b1020;';
            container.innerHTML = `
                <aside style="background:#ffffff; color:#111827; padding:20px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">Curriculum</h3>
                        <span id="backend-progress-pill" style="background:#ede9fe; color:#6d28d9; padding:4px 10px; border-radius:999px; font-size:12px;">${course.progress || 0}% Done</span>
                    </div>
                    <ul id="backend-lesson-list" style="list-style:none; margin:0; padding:0;"></ul>
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;">
                        <div style="padding:12px; background:#f8fafc; border-radius:12px; margin-bottom:12px;">
                            <p style="margin:0 0 4px 0; font-size:11px; color:#64748b;">üë®‚Äçüè´ Instructor</p>
                            <p style="margin:0; font-weight:600; font-size:13px;">${course.faculty_name || 'Faculty'}</p>
                        </div>
                        <div style="padding:12px; background:#f8fafc; border-radius:12px; margin-bottom:12px;">
                            <p style="margin:0 0 4px 0; font-size:11px; color:#64748b;">‚è±Ô∏è Duration</p>
                            <p style="margin:0; font-weight:600; font-size:13px;">${course.duration || studyHours + ' hours'}</p>
                        </div>
                        <div style="padding:12px; background:#f8fafc; border-radius:12px;">
                            <p style="margin:0 0 4px 0; font-size:11px; color:#64748b;">üìä Level</p>
                            <p style="margin:0; font-weight:600; font-size:13px; text-transform:capitalize;">${course.level || 'Beginner'}</p>
                        </div>
                    </div>
                </aside>
                <main style="padding:20px; background:radial-gradient(circle at top,#111827,#020617); color:#e5e7eb; overflow-y:auto;">
                    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <button id="backend-back-btn" style="background:#1f2937; border:none; color:#fff; padding:8px 14px; border-radius:10px; cursor:pointer;">‚Üê Courses</button>
                        <h2 id="backend-player-title" style="margin:0; color:#e5e7eb;">${course.title || 'Course'}</h2>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span id="video-time-display" style="background:#1f2937; padding:6px 12px; border-radius:999px; font-size:12px;">00:00</span>
                        </div>
                    </header>
                    <div id="backend-player-video" style="height:400px; background:#000; border-radius:18px; overflow:hidden; margin-bottom:20px;">
                        <div id="youtube-player-${videoID}"></div>
                    </div>
                    <section style="display:grid; grid-template-columns:2fr 1fr; gap:16px;">
                        <div style="background:#0f172a; padding:20px; border-radius:16px;">
                            <h3 id="backend-module-title" style="margin:0 0 10px 0;">Module 1</h3>
                            <p id="backend-module-desc" style="color:#cbd5e1; line-height:1.6;">${course.description || 'Learn and master the concepts in this course.'}</p>
                        </div>
                        <div style="background:#0f172a; padding:20px; border-radius:16px;">
                            <h4 style="margin:0 0 10px 0;">Progress</h4>
                            <div style="height:8px; background:#1e293b; border-radius:999px; margin:10px 0;">
                                <div id="backend-progress-fill" style="height:100%; width:${course.progress || 0}%; background:linear-gradient(90deg,#6366f1,#8b5cf6); border-radius:999px;"></div>
                            </div>
                            <p id="backend-progress-text" style="color:#cbd5e1;">0 / ${modules.length} Modules</p>
                        </div>
                    </section>
                </main>
                <aside style="background:#ffffff; color:#111827; padding:16px; overflow-y:auto;">
                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <button class="backend-tab active" data-tab="notes" style="flex:1; min-width:60px; border:none; padding:10px; border-radius:10px; background:#eef2ff; color:#4f46e5; cursor:pointer; font-size:11px; font-weight:600;">üìù Notes</button>
                        <button class="backend-tab" data-tab="lab" style="flex:1; min-width:60px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">üß™ Lab</button>
                        <button class="backend-tab" data-tab="tutor" style="flex:1; min-width:60px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">ü§ñ Tutor</button>
                        <button class="backend-tab" data-tab="camera" style="flex:1; min-width:60px; border:none; padding:10px; border-radius:10px; background:#f3f4f6; cursor:pointer; font-size:11px; font-weight:600;">üìπ Camera</button>
                    </div>
                    <div id="backend-panel-content" style="background:#0f172a; color:#e5e7eb; padding:16px; border-radius:16px; display:flex; flex-direction:column; height:calc(100% - 60px); overflow:hidden;">
                        <!-- Notes Tab -->
                        <div id="backend-panel-notes" class="backend-panel-tab active" style="display:flex; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                            <div id="backend-notes-content" style="flex:1; overflow-y:auto; font-size:13px; line-height:1.6; color:#cbd5e1; margin-bottom:12px; padding-right:8px;">
                                <p style="text-align:center; color:#9ca3af;">Loading notes...</p>
                            </div>
                            <button id="backend-download-notes-btn" style="width:100%; background:#6366f1; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">üì• Download Notes</button>
                        </div>
                        
                        <!-- Lab Tab -->
                        <div id="backend-panel-lab" class="backend-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                            <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                                <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                                    <button class="backend-lab-btn active" data-challenge="1" style="flex:1; min-width:60px; padding:8px 12px; background:#6366f1; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 1</button>
                                    <button class="backend-lab-btn" data-challenge="2" style="flex:1; min-width:60px; padding:8px 12px; background:#f3f4f6; color:#111827; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 2</button>
                                    <button class="backend-lab-btn" data-challenge="3" style="flex:1; min-width:60px; padding:8px 12px; background:#f3f4f6; color:#111827; border:none; border-radius:8px; cursor:pointer; font-size:11px; font-weight:600;">Challenge 3</button>
                                </div>
                                <div id="backend-lab-desc" style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px; font-size:12px; color:#cbd5e1; max-height:80px; overflow-y:auto;">
                                    <strong>Challenge 1: Practice Exercise</strong>
                                    <p style="margin:6px 0 0 0; color:#9ca3af;">Write code to practice what you learned in this module.</p>
                                </div>
                                <div style="flex:1; display:flex; flex-direction:column; overflow:hidden; margin-bottom:12px;">
                                    <label style="font-size:11px; color:#9ca3af; margin-bottom:6px;">Code Editor:</label>
                                    <textarea id="backend-lab-editor" style="flex:1; min-height:120px; padding:12px; background:#0f172a; color:#10b981; border:1px solid #334155; border-radius:8px; font-family:monospace; font-size:12px; resize:none;" placeholder="// Write your code here"></textarea>
                                </div>
                                <div style="display:flex; gap:8px; margin-bottom:12px;">
                                    <button id="backend-lab-run" style="flex:1; padding:10px 16px; background:#10b981; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">‚ñ∂ Run Code</button>
                                    <button id="backend-lab-reset" style="flex:1; padding:10px 16px; background:#f59e0b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">‚Üª Reset</button>
                                </div>
                                <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                                    <label style="font-size:11px; color:#9ca3af; margin-bottom:6px;">Output:</label>
                                    <div id="backend-lab-output" style="flex:1; min-height:60px; padding:12px; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#10b981; font-family:monospace; font-size:12px; overflow-y:auto;">
                                        <span style="color:#9ca3af;">Click "Run Code" to see output...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Tutor Tab -->
                        <div id="backend-panel-tutor" class="backend-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                            <div style="flex:1; overflow-y:auto; padding-right:8px; margin-bottom:12px;">
                                <h4 style="margin:0 0 12px 0; color:#cbd5e1;">ü§ñ AI Study Buddy</h4>
                                <div id="backend-tutor-chat" style="font-size:13px; color:#cbd5e1;">
                                    <div style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px;">
                                        <p style="margin:0; color:#9ca3af; font-size:12px;">Ask me anything about ${course.title}!</p>
                                    </div>
                                </div>
                            </div>
                            <input id="backend-tutor-input" type="text" placeholder="Ask a question..." style="width:100%; padding:10px 12px; border:1px solid #334155; border-radius:8px; background:#0f172a; color:#e5e7eb; font-size:12px; margin-bottom:8px;" />
                            <button id="backend-tutor-ask" style="width:100%; background:#f59e0b; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">Send Question</button>
                        </div>
                        
                        <!-- Camera Tab -->
                        <div id="backend-panel-camera" class="backend-panel-tab" style="display:none; flex-direction:column; height:100%; flex:1; overflow:hidden;">
                            <h4 style="margin:0 0 12px 0; color:#cbd5e1;">üìπ Camera Analysis</h4>
                            <div id="backend-camera-preview" style="width:100%; height:180px; background:#1e293b; border-radius:8px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                <video id="backend-camera-video" style="width:100%; height:100%; object-fit:cover; display:none;" autoplay muted></video>
                                <p id="backend-camera-placeholder" style="color:#9ca3af; font-size:12px;">Camera preview will appear here</p>
                            </div>
                            <div style="background:#1e293b; padding:12px; border-radius:8px; margin-bottom:12px;">
                                <p style="margin:0; color:#cbd5e1; font-size:12px;"><strong>Status:</strong> <span id="backend-camera-status" style="color:#f59e0b;">Not Active</span></p>
                                <p style="margin:8px 0 0 0; color:#9ca3af; font-size:11px;">Camera helps track engagement during learning.</p>
                            </div>
                            <button id="backend-enable-camera" style="width:100%; background:#3b82f6; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;">üé• Enable Camera</button>
                            <div id="backend-motivator" style="margin-top:12px; background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; color:#cbd5e1; font-weight:600; font-size:12px;">
                                    <span>ü§ñ</span> <span>AI Motivator</span>
                                </div>
                                <p id="backend-motivator-text" style="margin:0; color:#9ca3af; font-size:12px;">Let‚Äôs stay focused. Small steps add up‚Äîtry summarizing the last minute.</p>
                            </div>
                        </div>
                    </div>
                </aside>
            `;
            document.body.appendChild(container);
            
            // Initialize YouTube Player using IFrame API
            initializeYouTubePlayer(videoID, course);
            
            // Populate module list
            const lessonList = document.getElementById('backend-lesson-list');
            modules.forEach((mod, idx) => {
                const li = document.createElement('li');
                li.style.cssText = 'padding:12px; margin-bottom:8px; background:#f8fafc; border-radius:10px; cursor:pointer; transition:all 0.2s;';
                li.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="width:24px; height:24px; background:${idx === 0 ? '#6366f1' : '#e2e8f0'}; color:${idx === 0 ? '#fff' : '#64748b'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600;">${idx + 1}</span>
                        <div style="flex:1;">
                            <p style="margin:0; font-weight:600; font-size:13px;">${mod.title}</p>
                            <p style="margin:4px 0 0 0; font-size:11px; color:#64748b;">${mod.duration || '~30 min'}</p>
                        </div>
                    </div>
                `;
                li.addEventListener('click', () => selectBackendModule(idx, modules, course));
                li.addEventListener('mouseenter', () => li.style.background = '#eef2ff');
                li.addEventListener('mouseleave', () => li.style.background = idx === currentBackendModule ? '#eef2ff' : '#f8fafc');
                lessonList.appendChild(li);
            });
            
            // Store current state
            window.currentBackendModule = 0;
            window.backendModules = modules;
            window.backendCourse = course;
            
            // Set up event listeners
            setupBackendPlayerEvents(course, modules);
            
            // Load notes for first module
            loadBackendModuleNotes(course, modules[0]);
        }
        
        // Generate modules based on study hours
        function generateModulesForCourse(course, count) {
            const modules = [];
            const topics = [
                'Introduction & Setup',
                'Core Concepts',
                'Fundamentals Deep Dive',
                'Practical Applications',
                'Advanced Techniques',
                'Best Practices',
                'Real-world Examples',
                'Project Work',
                'Review & Assessment',
                'Summary & Next Steps'
            ];
            
            for (let i = 0; i < count; i++) {
                modules.push({
                    title: topics[i % topics.length] + (i >= topics.length ? ` Part ${Math.floor(i/topics.length) + 1}` : ''),
                    duration: '~30 min',
                    description: `Learn about ${topics[i % topics.length].toLowerCase()} in ${course.title || 'this course'}.`
                });
            }
            return modules;
        }
        
        // Initialize YouTube IFrame Player
        function initializeYouTubePlayer(videoID, course) {
            // Load YouTube IFrame API if not loaded
            if (!window.YT) {
                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                
                window.onYouTubeIframeAPIReady = function() {
                    createYouTubePlayer(videoID, course);
                };
            } else {
                createYouTubePlayer(videoID, course);
            }
        }
        
        function createYouTubePlayer(videoID, course) {
            const playerDiv = document.getElementById(`youtube-player-${videoID}`);
            if (!playerDiv) return;
            
            playerDiv.style.cssText = 'width:100%; height:100%;';
            
            window.backendYTPlayer = new YT.Player(`youtube-player-${videoID}`, {
                height: '100%',
                width: '100%',
                videoId: videoID,
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'autoplay': 0
                },
                events: {
                    'onReady': onBackendPlayerReady,
                    'onStateChange': onBackendPlayerStateChange,
                    'onError': onBackendPlayerError
                }
            });
        }
        
        function onBackendPlayerReady(event) {
            console.log('YouTube player ready');
            // Update time display periodically
            setInterval(() => {
                if (window.backendYTPlayer && window.backendYTPlayer.getCurrentTime) {
                    const time = window.backendYTPlayer.getCurrentTime();
                    const minutes = Math.floor(time / 60);
                    const seconds = Math.floor(time % 60);
                    const display = document.getElementById('video-time-display');
                    if (display) {
                        display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                }
            }, 1000);
        }
        
        function onBackendPlayerStateChange(event) {
            // Track progress when video is playing
            if (event.data === YT.PlayerState.PLAYING) {
                console.log('Video playing');
            }
        }
        
        function onBackendPlayerError(event) {
            console.error('YouTube player error:', event.data);
            // Show fallback
            const videoContainer = document.getElementById('backend-player-video');
            if (videoContainer) {
                const videoID = window.backendCourse?.video_url ? extractVideoId(window.backendCourse.video_url) : '';
                videoContainer.innerHTML = `
                    <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#111827; gap:16px;">
                        <p style="color:#94a3b8; font-size:14px;">Video cannot be embedded directly.</p>
                        <a href="https://www.youtube.com/watch?v=${videoID}" target="_blank" style="background:#ef4444; color:white; padding:12px 24px; border-radius:10px; text-decoration:none; font-weight:600;">
                            ‚ñ∂ Watch on YouTube
                        </a>
                    </div>
                `;
            }
        }
        
        // Select a module
        function selectBackendModule(idx, modules, course) {
            window.currentBackendModule = idx;
            const mod = modules[idx];
            
            // Update module info
            document.getElementById('backend-module-title').textContent = mod.title;
            document.getElementById('backend-module-desc').textContent = mod.description || course.description;
            
            // Update progress
            const progress = Math.round(((idx + 1) / modules.length) * 100);
            document.getElementById('backend-progress-fill').style.width = progress + '%';
            document.getElementById('backend-progress-text').textContent = `${idx + 1} / ${modules.length} Modules`;
            document.getElementById('backend-progress-pill').textContent = progress + '% Done';
            
            // Update lesson list styling
            const lessonList = document.getElementById('backend-lesson-list');
            lessonList.querySelectorAll('li').forEach((li, i) => {
                const circle = li.querySelector('span');
                if (i === idx) {
                    li.style.background = '#eef2ff';
                    circle.style.background = '#6366f1';
                    circle.style.color = '#fff';
                } else if (i < idx) {
                    li.style.background = '#f8fafc';
                    circle.style.background = '#10b981';
                    circle.style.color = '#fff';
                } else {
                    li.style.background = '#f8fafc';
                    circle.style.background = '#e2e8f0';
                    circle.style.color = '#64748b';
                }
            });
            
            // Load notes for this module
            loadBackendModuleNotes(course, mod);
        }
        
        // Load notes for a module
        async function loadBackendModuleNotes(course, mod) {
            const notesContent = document.getElementById('backend-notes-content');
            notesContent.innerHTML = '<p style="text-align:center; color:#9ca3af;">Generating notes...</p>';
            
            try {
                // Try to generate notes using AI
                const response = await fetch(`${API_BASE_URL}/summarize/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: `Generate study notes for: ${mod.title} in the course "${course.title}". ${mod.description || course.description}`,
                        max_length: 500
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notesContent.innerHTML = `
                        <h4 style="margin:0 0 12px 0; color:#e5e7eb;">${mod.title}</h4>
                        <div style="color:#cbd5e1; line-height:1.8;">
                            ${data.summary || data.notes || generateDefaultNotes(mod, course)}
                        </div>
                    `;
                } else {
                    notesContent.innerHTML = generateDefaultNotes(mod, course);
                }
            } catch (err) {
                notesContent.innerHTML = generateDefaultNotes(mod, course);
            }
        }
        
        function generateDefaultNotes(mod, course) {
            return `
                <h4 style="margin:0 0 12px 0; color:#e5e7eb;">${mod.title}</h4>
                <div style="color:#cbd5e1; line-height:1.8;">
                    <p><strong>üìö Overview:</strong> ${mod.description || 'Learn key concepts in this module.'}</p>
                    <p><strong>üéØ Learning Objectives:</strong></p>
                    <ul style="margin:8px 0; padding-left:20px;">
                        <li>Understand the fundamentals of ${mod.title.toLowerCase()}</li>
                        <li>Apply concepts through practical exercises</li>
                        <li>Build confidence with hands-on practice</li>
                    </ul>
                    <p><strong>üí° Tips:</strong> Take notes, practice coding, and ask the AI tutor if you have questions!</p>
                </div>
            `;
        }
        
        // Set up all event listeners for the player
        function setupBackendPlayerEvents(course, modules) {
            // Back button
            document.getElementById('backend-back-btn').addEventListener('click', () => {
                const player = document.getElementById('course-player-container');
                if (player) player.remove();
                if (window.backendYTPlayer) {
                    window.backendYTPlayer.destroy();
                    window.backendYTPlayer = null;
                }
                if (window.backendMotivatorInterval) {
                    clearInterval(window.backendMotivatorInterval);
                }
                endLearningSession();
            });
            
            // Tab switching
            document.querySelectorAll('.backend-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.backend-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.background = '#f3f4f6';
                        t.style.color = '#111827';
                    });
                    tab.classList.add('active');
                    tab.style.background = '#eef2ff';
                    tab.style.color = '#4f46e5';
                    
                    document.querySelectorAll('.backend-panel-tab').forEach(p => p.style.display = 'none');
                    const panel = document.getElementById('backend-panel-' + tab.dataset.tab);
                    if (panel) panel.style.display = 'flex';
                });
            });
            
            // Download notes
            document.getElementById('backend-download-notes-btn').addEventListener('click', () => {
                const notes = document.getElementById('backend-notes-content').innerText;
                const blob = new Blob([notes], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${course.title || 'Course'}_Notes.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // Lab functionality
            document.querySelectorAll('.backend-lab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.backend-lab-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = '#f3f4f6';
                        b.style.color = '#111827';
                    });
                    btn.classList.add('active');
                    btn.style.background = '#6366f1';
                    btn.style.color = '#fff';
                    
                    const challenge = btn.dataset.challenge;
                    document.getElementById('backend-lab-desc').innerHTML = `
                        <strong>Challenge ${challenge}: Practice Exercise</strong>
                        <p style="margin:6px 0 0 0; color:#9ca3af;">Write code to practice the concepts from this module.</p>
                    `;
                });
            });
            
            document.getElementById('backend-lab-run').addEventListener('click', () => {
                const code = document.getElementById('backend-lab-editor').value;
                const output = document.getElementById('backend-lab-output');
                try {
                    const result = eval(code);
                    output.innerHTML = `<span style="color:#10b981;">‚úì Output: ${result !== undefined ? result : 'Code executed successfully'}</span>`;
                } catch (err) {
                    output.innerHTML = `<span style="color:#ef4444;">‚úó Error: ${err.message}</span>`;
                }
            });
            
            document.getElementById('backend-lab-reset').addEventListener('click', () => {
                document.getElementById('backend-lab-editor').value = '// Write your code here';
                document.getElementById('backend-lab-output').innerHTML = '<span style="color:#9ca3af;">Click "Run Code" to see output...</span>';
            });
            
            // AI Tutor
            document.getElementById('backend-tutor-ask').addEventListener('click', () => askBackendTutor(course));
            document.getElementById('backend-tutor-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') askBackendTutor(course);
            });
            
            // Camera
            document.getElementById('backend-enable-camera').addEventListener('click', enableBackendCamera);

            // AI Motivator rotation for backend-created courses
            const backendMotivatorText = document.getElementById('backend-motivator-text');
            const backendMotivatorPrompts = [
                'Stay with it‚Äînote one key takeaway from this segment.',
                'Do a 30-second stretch, then recap the last topic.',
                'Mute phone distractions for 10 minutes and push through.',
                'Teach it aloud: explain this concept in one sentence.',
                'Hydrate check: sip water, then continue focused.'
            ];
            if (backendMotivatorText) {
                const setBackendPrompt = () => {
                    const pick = backendMotivatorPrompts[Math.floor(Math.random() * backendMotivatorPrompts.length)];
                    backendMotivatorText.textContent = pick;
                };
                if (window.backendMotivatorInterval) {
                    clearInterval(window.backendMotivatorInterval);
                }
                setBackendPrompt();
                window.backendMotivatorInterval = setInterval(setBackendPrompt, 45000);
            }
        }
        
        // AI Tutor functionality - Connected to Mistral AI
        async function askBackendTutor(course) {
            const input = document.getElementById('backend-tutor-input');
            const chat = document.getElementById('backend-tutor-chat');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user message with better formatting
            chat.innerHTML += `
                <div style="background:#3b82f6; color:#fff; padding:10px 12px; border-radius:12px 12px 4px 12px; margin-bottom:8px; font-size:13px; max-width:85%; margin-left:auto;">
                    ${escapeHtml(question)}
                </div>
            `;
            input.value = '';
            
            // Add loading message with animation
            const loadingId = 'loading-' + Date.now();
            chat.innerHTML += `
                <div id="${loadingId}" style="color:#9ca3af; font-size:12px; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                    <span class="loading-dots">ü§î Thinking</span>
                    <style>
                        .loading-dots::after {
                            content: '';
                            animation: dots 1.5s steps(4, end) infinite;
                        }
                        @keyframes dots {
                            0%, 20% { content: ''; }
                            40% { content: '.'; }
                            60% { content: '..'; }
                            80%, 100% { content: '...'; }
                        }
                    </style>
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
            
            // Get current module info
            const currentModule = window.backendModules ? window.backendModules[window.currentBackendModule || 0] : null;
            
            try {
                const response = await fetch(`${API_BASE_URL}/ai-tutor/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        course_title: course.title || 'this course',
                        course_description: course.description || '',
                        module_title: currentModule ? currentModule.title : ''
                    })
                });
                
                const loading = document.getElementById(loadingId);
                if (loading) loading.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    const answer = data.answer || 'I can help you with that! Try rephrasing your question.';
                    
                    // Format the answer with code highlighting if it contains code
                    const formattedAnswer = formatAIResponse(answer);
                    
                    chat.innerHTML += `
                        <div style="background:#1e293b; color:#cbd5e1; padding:12px 14px; border-radius:12px 12px 12px 4px; margin-bottom:8px; font-size:13px; line-height:1.6; max-width:90%;">
                            <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; color:#6366f1; font-size:11px; font-weight:600;">
                                ü§ñ AI Study Buddy
                            </div>
                            ${formattedAnswer}
                        </div>
                    `;
                } else {
                    chat.innerHTML += `
                        <div style="background:#1e293b; color:#cbd5e1; padding:10px 12px; border-radius:12px 12px 12px 4px; margin-bottom:8px; font-size:12px;">
                            <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px; color:#f59e0b; font-size:11px;">
                                ‚ö†Ô∏è Connection issue
                            </div>
                            I'm having trouble connecting right now. Please try again in a moment!
                        </div>
                    `;
                }
            } catch (err) {
                console.error('AI Tutor error:', err);
                const loading = document.getElementById(loadingId);
                if (loading) loading.remove();
                chat.innerHTML += `
                    <div style="background:#1e293b; color:#cbd5e1; padding:10px 12px; border-radius:12px 12px 12px 4px; margin-bottom:8px; font-size:12px;">
                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px; color:#f59e0b; font-size:11px;">
                            ‚ö†Ô∏è Offline mode
                        </div>
                        I'm here to help! Try asking specific questions about ${course.title}.
                    </div>
                `;
            }
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to format AI response with code blocks
        function formatAIResponse(text) {
            // Replace code blocks with styled versions
            let formatted = text
                // Handle ```code``` blocks
                .replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre style="background:#0f172a; padding:10px; border-radius:8px; margin:8px 0; overflow-x:auto; font-size:11px;"><code style="color:#10b981; font-family:monospace;">${escapeHtml(code.trim())}</code></pre>`;
                })
                // Handle inline `code`
                .replace(/`([^`]+)`/g, '<code style="background:#0f172a; padding:2px 6px; border-radius:4px; color:#10b981; font-family:monospace; font-size:11px;">$1</code>')
                // Convert newlines to <br>
                .replace(/\n/g, '<br>')
                // Bold text **text**
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Convert numbered lists
                .replace(/(\d+)\.\s/g, '<br>$1. ');
            
            return formatted;
        }
        
        // Immersive overlay helpers
        let immersiveOverlay;
        function ensureImmersiveOverlay() {
            if (immersiveOverlay) return;
            immersiveOverlay = document.createElement('div');
            immersiveOverlay.id = 'immersive-overlay';
            immersiveOverlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.82); z-index:9999; display:none; align-items:center; justify-content:center; padding:24px;';
            immersiveOverlay.innerHTML = `
                <div style="width:100%; max-width:720px; background:#0f172a; border:1px solid #1f2937; border-radius:16px; padding:20px; color:#e5e7eb; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.45);">
                    <button id="immersive-close" style="position:absolute; top:12px; right:12px; background:#1f2937; color:#e5e7eb; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; font-weight:bold;">√ó</button>
                    <h3 style="margin:0 0 10px 0; display:flex; align-items:center; gap:8px;">üï∂Ô∏è Immersive Preview (beta)</h3>
                    <p id="immersive-support" style="margin:0 0 12px 0; color:#9ca3af; font-size:13px;">Checking your browser for WebXR (AR/VR) support...</p>
                    <div style="display:grid; grid-template-columns:1.2fr 0.8fr; gap:14px; align-items:stretch;">
                        <div style="background:linear-gradient(135deg,#0ea5e9,#6366f1); border-radius:14px; padding:16px; position:relative; overflow:hidden; min-height:180px;">
                            <div style="position:absolute; inset:14px; border:1px solid rgba(255,255,255,0.18); border-radius:12px;"></div>
                            <div style="position:absolute; width:120px; height:120px; border-radius:50%; background:rgba(255,255,255,0.08); top:24px; right:-20px; filter:blur(0px);"></div>
                            <div style="position:absolute; width:160px; height:160px; border-radius:50%; background:rgba(255,255,255,0.06); bottom:-40px; left:-30px;"></div>
                            <div style="position:relative; z-index:1;">
                                <p style="margin:0; font-weight:700; font-size:14px;">Spatial Study Bubble</p>
                                <p style="margin:6px 0 12px 0; font-size:12px; color:#e0f2fe;">Visualize concepts in a floating 3D bubble. Use headset or phone with AR-capable browser.</p>
                                <div id="immersive-cta" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                            </div>
                        </div>
                        <div style="background:#111827; border:1px solid #1f2937; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px;">
                            <div style="font-size:13px; color:#cbd5e1;">What you can try now:</div>
                            <ul style="margin:0; padding-left:18px; color:#9ca3af; font-size:12px; line-height:1.5;">
                                <li>AR overlay for focus cues (camera-based)</li>
                                <li>VR mini-room to pin notes and code snippets</li>
                                <li>3D object/diagram viewer per module</li>
                            </ul>
                            <p style="margin:0; font-size:12px; color:#9ca3af;">If AR/VR is unsupported, we will fall back to a non-immersive preview.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(immersiveOverlay);
            const closeBtn = immersiveOverlay.querySelector('#immersive-close');
            if (closeBtn) closeBtn.onclick = () => immersiveOverlay.style.display = 'none';
        }

        async function showImmersiveOverlay() {
            ensureImmersiveOverlay();
            immersiveOverlay.style.display = 'flex';
            const supportEl = document.getElementById('immersive-support');
            const ctaEl = document.getElementById('immersive-cta');
            if (!supportEl || !ctaEl) return;
            ctaEl.innerHTML = '';
            const addCta = (label, fn) => {
                const btn = document.createElement('button');
                btn.textContent = label;
                btn.style.cssText = 'background:#0b172a; color:#e5e7eb; border:1px solid rgba(255,255,255,0.18); padding:8px 10px; border-radius:10px; font-size:12px; cursor:pointer;';
                btn.onclick = fn;
                ctaEl.appendChild(btn);
            };
            if (navigator.xr && navigator.xr.isSessionSupported) {
                const arSupported = await navigator.xr.isSessionSupported('immersive-ar').catch(() => false);
                const vrSupported = await navigator.xr.isSessionSupported('immersive-vr').catch(() => false);
                supportEl.textContent = `AR support: ${arSupported ? 'Yes' : 'No'} | VR support: ${vrSupported ? 'Yes' : 'No'}`;
                addCta('Start AR preview', () => {
                    immersiveOverlay.style.display = 'none';
                    startARPreview();
                });
                addCta('Start VR room', () => alert('Launch a WebXR immersive-vr session with a minimal study room scene.'));
            } else {
                supportEl.textContent = 'WebXR not detected. Showing 3D preview instead.';
                addCta('View 3D preview', () => {
                    immersiveOverlay.style.display = 'none';
                    startARPreview();
                });
            }
            addCta('See 3D concept', () => alert('Load a 3D model viewer for this module as a fallback.'));
        }

        // Lab immersive overlay for code visualization
        function showLabImmersiveOverlay(code, output) {
            ensureImmersiveOverlay();
            const overlay = immersiveOverlay;
            const contentDiv = overlay.querySelector('div[style*="max-width"]');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <button id="immersive-close" style="position:absolute; top:12px; right:12px; background:#1f2937; color:#e5e7eb; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; font-weight:bold;">√ó</button>
                    <h3 style="margin:0 0 10px 0; display:flex; align-items:center; gap:8px;">üï∂Ô∏è Code Visualization (beta)</h3>
                    <p style="margin:0 0 12px 0; color:#9ca3af; font-size:13px;">Visualize your code execution in AR/VR space.</p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
                        <div style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:200px; overflow-y:auto;">
                            <p style="margin:0 0 8px 0; font-size:12px; color:#cbd5e1; font-weight:600;">Code</p>
                            <pre style="margin:0; background:#0f172a; padding:8px; border-radius:8px; color:#10b981; font-size:11px; overflow-x:auto; white-space:pre-wrap; word-wrap:break-word;">${code}</pre>
                        </div>
                        <div style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:200px; overflow-y:auto;">
                            <p style="margin:0 0 8px 0; font-size:12px; color:#cbd5e1; font-weight:600;">Output</p>
                            <pre style="margin:0; background:#0f172a; padding:8px; border-radius:8px; color:#10b981; font-size:11px; overflow-x:auto; white-space:pre-wrap; word-wrap:break-word;">${output}</pre>
                        </div>
                    </div>
                    <div style="margin-top:14px; display:flex; gap:8px;">
                        <button style="flex:1; background:#0ea5e9; color:#fff; border:none; padding:10px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;" onclick="alert('Step through code execution with AR callstack visualization.')">Visualize Steps</button>
                        <button style="flex:1; background:#f59e0b; color:#fff; border:none; padding:10px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:600;" onclick="alert('Pin this code snippet to a floating VR notebook.')">Save to VR Notebook</button>
                    </div>
                `;
                const closeBtn = contentDiv.querySelector('#immersive-close');
                if (closeBtn) closeBtn.onclick = () => overlay.style.display = 'none';
            }
            overlay.style.display = 'flex';
        }

        // Camera functionality
        async function enableBackendCamera() {
            const video = document.getElementById('backend-camera-video');
            const placeholder = document.getElementById('backend-camera-placeholder');
            const status = document.getElementById('backend-camera-status');
            const btn = document.getElementById('backend-enable-camera');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                status.textContent = 'Active';
                status.style.color = '#10b981';
                btn.textContent = 'üé• Camera Active';
                btn.style.background = '#10b981';
                btn.disabled = true;
            } catch (err) {
                status.textContent = 'Permission Denied';
                status.style.color = '#ef4444';
                alert('Camera access denied. Please enable camera permissions.');
            }
        }
        
        // Save notes for backend course
        function saveBackendCourseNotes(courseId) {
            const notes = document.getElementById('backend-course-notes').value;
            localStorage.setItem(`backend-course-notes-${courseId}`, notes);
            alert('Notes saved!');
        }

        function viewBackendCourse(courseId) {
            // Legacy function - redirect to new player
            const courseIndex = courses.findIndex(c => c.id === courseId);
            if (courseIndex >= 0) {
                openBackendCoursePlayer(courseIndex);
            }
        }

        function isValidYoutube(url) {
            try {
                const u = new URL(url);
                return u.hostname.includes('youtube.com') || u.hostname === 'youtu.be';
            } catch (e) {
                return false;
            }
        }

        async function generateCurriculum() {
            const title = (titleInput.value || '').trim();
            const link = (linkInput.value || '').trim();
            const minutes = parseInt(minutesInput.value || '90', 10);
            const dailyHours = Math.max(0.5, minutes / 60); // backend expects hours

            if (!title || !link) {
                alert('Please enter a course title and YouTube link.');
                return;
            }
            if (!isValidYoutube(link)) {
                alert('Please enter a valid YouTube link.');
                return;
            }

            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generating‚Ä¶';
            generateBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/generate-plan/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseTitle: title,
                        courseLink: link,
                        dailyStudyHours: dailyHours
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Failed to generate curriculum');
                }

                const plan = await res.json();
                console.log('Generated plan', plan);

                // Persist locally and render in "Your Courses"
                courses.push({ ...plan, courseLink: link });
                saveCourses();
                renderCourses();

                alert(`Curriculum ready for ${plan.courseTitle}. Modules: ${plan.dailyPlan?.length || 0}`);
                closeCourseModal();
                showView('courses');
            } catch (err) {
                console.error(err);
                alert(err.message || 'Something went wrong while generating the curriculum.');
            } finally {
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }

        if (generateBtn) {
            generateBtn.addEventListener('click', generateCurriculum);
        }

        // Update Today's Focus with first course
        function updateTodaysFocus() {
            const courses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
            const focusContent = document.getElementById('today-focus-content');
            
            if (!focusContent) return;
            
            if (courses.length === 0) {
                focusContent.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#9ca3af;">
                        <p>üìö No course in focus yet</p>
                        <p style="font-size:12px;">Generate or add a course to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Get the first course
            const course = courses[0];
            const courseIndex = 0;
            const dailyPlan = course.dailyPlan || [];
            
            // Calculate progress
            const completed = dailyPlan.filter(m => m.completed).length;
            const total = dailyPlan.length;
            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            // Get remaining duration
            const remainingModules = dailyPlan.filter(m => !m.completed);
            const remainingMinutes = Math.round(remainingModules.reduce((sum, m) => sum + (m.duration || 1) * 60, 0));
            
            focusContent.innerHTML = `
                <div class="progress-circle">
                    <svg width="80" height="80">
                        <circle cx="40" cy="40" r="35" class="bg" fill="none" stroke="#334155" stroke-width="3"></circle>
                        <circle cx="40" cy="40" r="35" class="prog" fill="none" stroke="#6366f1" stroke-width="3" style="stroke-dasharray: ${219.8 * progressPercent / 100} 219.8; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dasharray 0.3s;"></circle>
                    </svg>
                    <span class="percent" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; color:#e5e7eb;">${progressPercent}%</span>
                </div>
                <div class="focus-text">
                    <h3 style="margin:0 0 8px 0;">${course.courseTitle || 'Your Course'}</h3>
                    <div class="meta" style="font-size:12px; color:#9ca3af;">
                        <span><i class="far fa-clock"></i> ${remainingMinutes} min remaining</span>
                        <span style="margin-left:12px;"><i class="fas fa-book"></i> ${completed}/${total} modules</span>
                    </div>
                </div>
            `;
            
            // Add action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'focus-actions';
            actionsDiv.style.cssText = 'display:flex; gap:12px; margin-top:16px;';
            actionsDiv.innerHTML = `
                <button id="focus-continue-btn" style="flex:1; padding:10px 16px; background:#6366f1; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">Continue Learning ‚Üí</button>
            `;
            focusContent.appendChild(actionsDiv);
            
            // Add click handler
            const continueBtn = actionsDiv.querySelector('#focus-continue-btn');
            if (continueBtn) {
                continueBtn.onclick = () => {
                    openCoursePlayer(courseIndex);
                };
            }
        }

        // Initial render from any saved courses
        loadCurrentStudent(); // Load logged-in student info
        loadEnrolledCourses(); // Load enrolled courses from backend
        renderCourses();
        updateTodaysFocus();
        updateActivityGraphs(); // Load learning activity graph
    </script>

    <!-- AR/VR Three.js setup -->
    <script>
        let arCanvas, arRenderer, arScene, arCamera;

        function initARCanvas() {
            arCanvas = document.getElementById('ar-canvas');
            arRenderer = new THREE.WebGLRenderer({ canvas: arCanvas, alpha: true, antialias: true });
            arRenderer.setSize(window.innerWidth, window.innerHeight);
            arRenderer.setClearColor(0x000000, 0.1);

            arScene = new THREE.Scene();
            arCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            arCamera.position.z = 5;

            // Add lighting
            const light = new THREE.PointLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            arScene.add(light);

            const ambientLight = new THREE.AmbientLight(0x404040);
            arScene.add(ambientLight);

            // Add sample 3D objects
            addARObjects();

            window.addEventListener('resize', () => {
                arRenderer.setSize(window.innerWidth, window.innerHeight);
                arCamera.aspect = window.innerWidth / window.innerHeight;
                arCamera.updateProjectionMatrix();
            });

            animate();
        }

        function addARObjects() {
            // Create floating cubes (concept boxes)
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshPhongMaterial({ color: 0x6366f1 });
            
            const cube1 = new THREE.Mesh(geometry, material);
            cube1.position.set(-2, 0, 0);
            cube1.userData.rotation = { x: 0.01, y: 0.01 };
            arScene.add(cube1);

            const material2 = new THREE.MeshPhongMaterial({ color: 0x22c55e });
            const cube2 = new THREE.Mesh(geometry, material2);
            cube2.position.set(0, 0, 0);
            cube2.userData.rotation = { x: 0.015, y: -0.01 };
            arScene.add(cube2);

            const material3 = new THREE.MeshPhongMaterial({ color: 0x0ea5e9 });
            const cube3 = new THREE.Mesh(geometry, material3);
            cube3.position.set(2, 0, 0);
            cube3.userData.rotation = { x: -0.01, y: 0.015 };
            arScene.add(cube3);

            // Add text label sphere
            const sphereGeom = new THREE.SphereGeometry(0.5, 32, 32);
            const sphereMat = new THREE.MeshPhongMaterial({ color: 0xf59e0b });
            const sphere = new THREE.Mesh(sphereGeom, sphereMat);
            sphere.position.set(0, 2, 0);
            sphere.userData.rotation = { x: 0.01, y: 0.01 };
            arScene.add(sphere);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Rotate objects
            arScene.children.forEach(child => {
                if (child.userData.rotation) {
                    child.rotation.x += child.userData.rotation.x;
                    child.rotation.y += child.userData.rotation.y;
                }
            });

            arRenderer.render(arScene, arCamera);
        }

        function startARPreview() {
            if (!arCanvas) initARCanvas();
            arCanvas.style.display = 'block';
            
            // Create overlay UI
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:10001; display:flex; flex-direction:column; justify-content:space-between; padding:20px;';
            overlay.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="color:#e5e7eb; font-size:20px; margin:0;">üï∂Ô∏è AR Preview - Concept Visualization</h2>
                    <button id="close-ar" style="background:#ef4444; color:#fff; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:600;">Close AR</button>
                </div>
                <div style="background:rgba(15,23,42,0.92); border:1px solid #334155; border-radius:10px; padding:16px; color:#cbd5e1; font-size:13px; max-width:350px;">
                    <p style="margin:0 0 10px 0; font-weight:600;">üí° AR Learning Concepts</p>
                    <p style="margin:0 0 8px 0;">‚Ä¢ Blue cube: Algorithm</p>
                    <p style="margin:0 0 8px 0;">‚Ä¢ Green cube: Data Structure</p>
                    <p style="margin:0 0 8px 0;">‚Ä¢ Cyan cube: Function Logic</p>
                    <p style="margin:0 0 0 0;">‚Ä¢ Yellow sphere: Execution Flow</p>
                </div>
            `;
            document.body.appendChild(overlay);

            const closeBtn = overlay.querySelector('#close-ar');
            closeBtn.onclick = () => {
                arCanvas.style.display = 'none';
                overlay.remove();
            };
        }
    </script>
=======
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SparkLess | AI Learning Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
              mono: ['Fira Code', 'monospace'],
            },
            colors: {
              primary: {
                DEFAULT: '#4F46E5', // Indigo 600
                dark: '#4338ca',
                light: '#818cf8',
              },
              secondary: {
                DEFAULT: '#8B5CF6', // Purple 500
              },
              success: '#10B981',
              warning: '#F59E0B',
              error: '#EF4444',
              slate: {
                850: '#1e293b', // Custom dark slate
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.5s ease-out',
              'wave': 'wave 2.5s infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              wave: {
                '0%': { transform: 'rotate(0.0deg)' },
                '10%': { transform: 'rotate(14.0deg)' },
                '20%': { transform: 'rotate(-8.0deg)' },
                '30%': { transform: 'rotate(14.0deg)' },
                '40%': { transform: 'rotate(-4.0deg)' },
                '50%': { transform: 'rotate(10.0deg)' },
                '60%': { transform: 'rotate(0.0deg)' },
                '100%': { transform: 'rotate(0.0deg)' },
              }
            }
          },
        },
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react-dom": "https://esm.sh/react-dom@^19.2.3"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
>>>>>>> 80605234bd2e6cc36a304a6b4ab089eab8d57c4e
</body>
</html>