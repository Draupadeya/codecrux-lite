{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCrux: System Readiness</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* --- Existing CSS (Restored and Consolidated) --- */
        :root {
            --header-blue: #3399FF; 
            --success-green: #28a745; 
            --fail-red: #dc3545; 
            --bg-color: #f7f7f7; 
            --text-dark: #121212;
            --text-muted: #6c757d;
            --font-family: 'Roboto', sans-serif;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            --practice-color: #1a73e8; /* Blue accent for Practice */
        }
        body { 
            font-family: var(--font-family);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            background-color: #020617; /* Deep slate base under animated layers */
            position: relative;
            overflow-x: hidden;
        }

        /* ---------- Full-screen creative loader before dashboard appears ---------- */
        .dashboard-loader {
            position: fixed;
            inset: 0;
            z-index: 1200;
            display: flex;
            align-items: center;
            justify-content: center;
            background:
                radial-gradient(circle at top, rgba(15,23,42,0.9), transparent 60%),
                radial-gradient(circle at bottom, rgba(30,64,175,0.9), transparent 65%),
                #020617;
            backdrop-filter: blur(18px);
            transition: opacity 0.7s ease, transform 0.7s ease;
        }

        .dashboard-loader.hide {
            opacity: 0;
            transform: scale(1.03);
            pointer-events: none;
        }

        .loader-orbit {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .loader-orbit-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 2px dashed rgba(148, 163, 184, 0.6);
            box-shadow: 0 0 18px rgba(56, 189, 248, 0.6);
            animation: loader-rotate 8s linear infinite;
        }

        .loader-dot {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #f9fafb, #22c55e);
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.9);
        }

        .loader-dot.dot-1 { top: -6px; left: 50%; transform: translateX(-50%); animation: loader-dot-orbit-1 2.4s ease-in-out infinite; }
        .loader-dot.dot-2 { right: -6px; top: 50%; transform: translateY(-50%); animation: loader-dot-orbit-2 2.8s ease-in-out infinite; }
        .loader-dot.dot-3 { bottom: -6px; left: 50%; transform: translateX(-50%); animation: loader-dot-orbit-3 3.1s ease-in-out infinite; }

        .loader-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 18px);
            font-size: 0.85rem;
            color: #d1d5db;
            letter-spacing: 0.16em;
        }

        /* Advanced animated HD background for student dashboard */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            z-index: 0;
            background:
                linear-gradient(135deg, rgba(15,23,42,0.9), rgba(30,64,175,0.9)),
                url('https://images.pexels.com/photos/4644818/pexels-photo-4644818.jpeg?auto=compress&cs=tinysrgb&w=1600')
                    no-repeat center center fixed;
            background-size: cover;
            transform: scale(1.05) translate3d(0, 0, 0);
            will-change: transform, filter;
            animation: dashboard-bg-pan-zoom 18s ease-in-out infinite alternate;
            pointer-events: none;
        }

        body::after {
            content: "";
            position: fixed;
            inset: -20%;
            z-index: 0;
            background:
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.22), transparent 60%),
                radial-gradient(circle at 80% 80%, rgba(244, 114, 182, 0.26), transparent 60%),
                radial-gradient(circle at 50% 0%, rgba(52, 211, 153, 0.22), transparent 55%);
            mix-blend-mode: screen;
            opacity: 0.8;
            filter: blur(12px);
            pointer-events: none;
            will-change: transform, opacity, filter;
            animation: dashboard-bg-orbit 22s cubic-bezier(0.45, 0.05, 0.2, 0.95) infinite alternate;
        }

        /* Header Section */
        .header-section {
            background: var(--header-blue); 
            padding: 80px 0 40px;
            margin-bottom: 50px;
            text-align: center;
            color: white; 
        }
        .header-section h1 {
            font-size: 2.5rem; 
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }
        .header-section p {
            font-size: 1.1rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }
        .header-section .user-id { font-weight: 900; }
        .header-section .hand-wave {
            font-size: 1.8rem;
            vertical-align: middle;
            margin-left: 10px;
        }
        
        .main-title {
            font-weight: 500 !important; 
            color: var(--text-dark);
            margin-bottom: 50px;
        }

        /* While loading (before skeleton-loaded), keep header/cards subtle and let skeleton handle shimmer */
        body:not(.skeleton-loaded) .header-section,
        body:not(.skeleton-loaded) .main-title,
        body:not(.skeleton-loaded) .check-card {
            opacity: 0;
            transform: translateY(22px) scale(0.97);
        }

        /* After load, advanced entrance + float animations */
        body.skeleton-loaded .header-section {
            position: relative;
            z-index: 1;
            background: rgba(51, 153, 255, 0.96);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.55);
            animation: header-float 18s ease-in-out infinite alternate;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        body.skeleton-loaded .main-title {
            position: relative;
            z-index: 1;
            color: #e5e7eb;
            animation: title-fade 1.1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Check Status Cards */
        .check-card {
            --mouse-x: 0;
            --mouse-y: 0;
            background: white; 
            border-radius: 12px;
            padding: 30px 20px 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: 1px solid #e0e0e0;
            height: 100%;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transform-style: preserve-3d;
        }
        .check-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--text-muted); 
        }
        .check-title {
            font-size: 1.2rem;
            font-weight: 500; 
            margin-bottom: 10px;
        }
        .status-text { 
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 15px !important;
        }

        /* Success State */
        .status-ok .status-text { 
            color: var(--success-green); 
            font-weight: 700; 
        }
        .status-ok .btn-outline-success { 
            color: var(--success-green); 
            border-color: var(--success-green); 
            font-weight: 500; 
        }
        /* Blocked/Failed State */
        .blocked-card .check-icon { color: var(--fail-red); }
        .btn-start-exam {
            background-color: #F7808F;
            color: white; 
            border-radius: 8px;
            padding: 10px 30px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .btn-start-exam:disabled { background-color: #F7808F; opacity: 0.9; }

        /* Practice Button Style */
        .btn-practice {
            background-color: var(--practice-color); /* Blue */
            color: white; 
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .practice-card .check-icon { color: var(--practice-color); }

        /* Card-specific advanced animations for Courses and Start Exam */
        body.skeleton-loaded .card-interactive {
            transition: transform 0.28s ease, box-shadow 0.28s ease, border-color 0.28s ease;
            transform: perspective(900px) translateY(-2px) rotateX(calc(var(--mouse-y) * 9deg)) rotateY(calc(var(--mouse-x) * -9deg));
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
        }

        body.skeleton-loaded .card-interactive:hover {
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
            border-color: rgba(129, 140, 248, 0.85);
        }

        /* Moving highlight following mouse for realism */
        .card-interactive::after {
            content: "";
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at calc(50% + var(--mouse-x) * 40%) calc(40% + var(--mouse-y) * 40%), rgba(255, 255, 255, 0.55), transparent 55%);
            opacity: 0.0;
            mix-blend-mode: screen;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        body.skeleton-loaded .card-interactive:hover::after {
            opacity: 1;
        }

        /* Icon motion for both cards */
        body.skeleton-loaded .practice-card .check-icon,
        body.skeleton-loaded .status-ok .check-icon {
            animation: card-icon-bob 3.8s ease-in-out infinite;
            transform-origin: center bottom;
        }

        body.skeleton-loaded .practice-card:hover .check-icon,
        body.skeleton-loaded .status-ok:hover .check-icon {
            animation-duration: 2.2s;
        }

        /* Animated entrance and breathing for cards after load */
        body.skeleton-loaded .check-card {
            animation:
                card-enter 0.85s cubic-bezier(0.16, 1, 0.3, 1) forwards,
                card-breathe 9s ease-in-out 1s infinite;
        }

        .check-card::before {
            content: "";
            position: absolute;
            inset: -30%;
            background:
                radial-gradient(circle at top left, rgba(59, 130, 246, 0.25), transparent 60%),
                radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.3), transparent 65%);
            opacity: 0.7;
            mix-blend-mode: soft-light;
            pointer-events: none;
            will-change: transform, opacity, filter;
            animation: card-orbit 20s cubic-bezier(0.45, 0.05, 0.2, 0.95) infinite alternate;
        }

        /* Background + card animation keyframes */
        @keyframes dashboard-bg-pan-zoom {
            0% {
                transform: scale(1.05) translate3d(0, 0, 0);
                filter: brightness(1) saturate(1.05);
            }
            50% {
                transform: scale(1.12) translate3d(18px, -12px, 0);
                filter: brightness(1.04) saturate(1.1);
            }
            100% {
                transform: scale(1.18) translate3d(-18px, 12px, 0);
                filter: brightness(1.08) saturate(1.16);
            }
        }

        @keyframes dashboard-bg-orbit {
            0% {
                transform: translate3d(-20px, 10px, 0) scale(1.05) rotate(0deg);
                opacity: 0.65;
                filter: blur(14px);
            }
            50% {
                transform: translate3d(12px, -18px, 0) scale(1.15) rotate(8deg);
                opacity: 0.92;
                filter: blur(10px);
            }
            100% {
                transform: translate3d(26px, 16px, 0) scale(1.22) rotate(-6deg);
                opacity: 0.75;
                filter: blur(16px);
            }
        }

        @keyframes header-float {
            0%, 100% {
                transform: translateY(0) translateZ(0);
            }
            50% {
                transform: translateY(4px) translateZ(0);
            }
        }

        @keyframes title-fade {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes card-enter {
            0% {
                opacity: 0;
                transform: translateY(26px) scale(0.97);
                filter: blur(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @keyframes card-breathe {
            0%, 100% {
                box-shadow: 0 4px 18px rgba(15, 23, 42, 0.45);
            }
            50% {
                box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
            }
        }

        @keyframes card-orbit {
            0% {
                transform: translate3d(-8px, 6px, 0) rotate(0deg) scale(1.03);
                opacity: 0.6;
                filter: blur(10px);
            }
            50% {
                transform: translate3d(6px, -6px, 0) rotate(6deg) scale(1.08);
                opacity: 0.85;
                filter: blur(6px);
            }
            100% {
                transform: translate3d(10px, 4px, 0) rotate(-5deg) scale(1.1);
                opacity: 0.7;
                filter: blur(11px);
            }
        }

        /* Loader animations */
        @keyframes loader-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loader-dot-orbit-1 {
            0%, 100% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, 6px) scale(1.15); }
        }

        @keyframes loader-dot-orbit-2 {
            0%, 100% { transform: translate(0, -50%) scale(1); }
            50% { transform: translate(-6px, -50%) scale(1.15); }
        }

        @keyframes loader-dot-orbit-3 {
            0%, 100% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, -6px) scale(1.15); }
        }

        @keyframes card-icon-bob {
            0%, 100% {
                transform: translateY(0) scale(1);
                text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            }
            25% {
                transform: translateY(-4px) scale(1.06);
                text-shadow: 0 0 14px rgba(37, 99, 235, 0.6);
            }
            50% {
                transform: translateY(0) scale(1.02);
                text-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
            }
            75% {
                transform: translateY(-3px) scale(1.04);
                text-shadow: 0 0 12px rgba(45, 212, 191, 0.5);
            }
        }
        
    </style>
    <link rel="stylesheet" href="http://127.0.0.1:5000/style.css">
</head>
<body>

<div id="studentDashboardLoader" class="dashboard-loader">
    <div class="loader-orbit">
        <div class="loader-orbit-ring"></div>
        <span class="loader-dot dot-1"></span>
        <span class="loader-dot dot-2"></span>
        <span class="loader-dot dot-3"></span>
        <div class="loader-label">Preparing your space...</div>
    </div>
</div>

<header class="header-section skeleton-overlay-card">
    <h1 style="font-weight: 400;">
        Hello,
        <span class="user-id">
            {% if request.user.get_full_name %}
                {{ request.user.get_full_name }}
            {% elif request.user.username %}
                {{ request.user.username }}
            {% else %}
                Student
            {% endif %}
        </span>
        <span class="hand-wave">ðŸ‘‹</span>
    </h1>
    <p>Complete your pre-exam checks or start a practice session with <strong>CodeCrux</strong>.</p>
</header>

<div class="container pb-5 skeleton-overlay-card">

    <h2 class="text-center main-title">
        Welcome to CodeCrux
    </h2>

    <div class="row g-4 justify-content-center">
        
        <!-- Courses Card -->
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="check-card practice-card card-interactive">
                <i class="check-icon fas fa-laptop-code"></i>
                <h5 class="check-title">COURSES</h5>
                <p class="status-text mb-4 text-muted">Test your skills in a simulated, non-proctored environment.</p>
                
                <a href="http://localhost:5000/courses?user={{ request.user.username }}&session_id={% if request.session.session_key %}{{ request.session.session_key }}{% endif %}" 
                   target="_blank" 
                   class="btn btn-practice w-100"
                   title="Opens Flask StudyMate course portal">
                    <i class="fas fa-terminal me-2"></i> GO TO COURSES
                </a>
            </div>
        </div>

        <!-- Start Exam Card -->
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="check-card status-ok card-interactive" style="border: 2px solid var(--success-green);">
                <i class="check-icon fas fa-book-reader" style="color: var(--success-green);"></i>
                <h5 class="check-title" style="font-weight: 700;">START EXAM</h5>
                <p class="mb-4 status-text" style="color: var(--success-green); font-weight: 500;">Begin your proctored exam session</p>
                <button id="startExamButton" class="btn w-100" style="background-color: var(--success-green); color: white; border-radius: 8px; font-size: 1rem; padding: 10px 30px; font-weight: 700; text-transform: uppercase;">
                    <i class="fas fa-arrow-right me-2"></i> START EXAM
                </button>
            </div>
        </div>

    </div> 
</div>

<script>
    // Disable skeleton overlays once the student dashboard has fully loaded
    window.addEventListener('load', function () {
        document.body.classList.add('skeleton-loaded');

        // Fade out creative loader
        const loader = document.getElementById('studentDashboardLoader');
        if (loader) {
            loader.classList.add('hide');
            setTimeout(() => {
                loader.style.display = 'none';
            }, 800);
        }

        // Activate realistic 3D tilt for interactive cards
        const interactiveCards = document.querySelectorAll('.card-interactive');
        interactiveCards.forEach(card => {
            const bounds = card.getBoundingClientRect();

            function handleMove(e) {
                const rect = bounds; // static snapshot is fine for this page
                const x = (e.clientX - rect.left) / rect.width;   // 0 to 1
                const y = (e.clientY - rect.top) / rect.height;  // 0 to 1

                // Map to -1 .. 1 range
                const mx = (x - 0.5) * 2;
                const my = (y - 0.5) * 2;

                card.style.setProperty('--mouse-x', mx.toFixed(3));
                card.style.setProperty('--mouse-y', my.toFixed(3));
            }

            function resetTilt() {
                card.style.setProperty('--mouse-x', 0);
                card.style.setProperty('--mouse-y', 0);
            }

            card.addEventListener('mousemove', handleMove);
            card.addEventListener('mouseleave', resetTilt);
        });
    });

    // Existing dashboard JS
    // Get the CSRF token from the cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('startExamButton');
        
        if (startButton) {
            startButton.addEventListener('click', function() {
                // Redirect to the new multi-step exam flow
                // The exam_flow view will handle all checks: mic â†’ webcam â†’ rules â†’ exam
                window.location.href = "{% url 'exam_flow' %}";
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>